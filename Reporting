%let an=16; /*Annee de la mise a jour 20xx*/%let mois=10; /*Mois de la mise a jour xx*/%let an1=15; /*Annee precedente de l'annee de la mise a jour*/libname Central "~/PUBLIC/IAA160/ReportingProduit"; /*Bibliotheque de creation des bases*//* Import des caracteristiques des supports pour RCV et NOVA*/PROC IMPORT OUT=supportDATAFILE= "~/NAS/M/eQUIPES/Produits & Normes/Aubonnet_N - equipe/17 - Stats Produits/SAS/Etude/Import/support&an.&mois..xls"DBMS=XLS REPLACE; GETNAMES=YES;RUN;data support;set support; format code_support $30.; code_support=codsup;run; proc sort data=support nodupkey;by code_support;run;/*Import des types de gestion et nom de produits pour tous les systemes*/PROC IMPORT OUT=gestionDATAFILE= "~/NAS/M/eQUIPES/Produits & Normes/Aubonnet_N - equipe/17 - Stats Produits/SAS/Etude/Import/type_gestion&an.&mois..xls"DBMS=XLS REPLACE; GETNAMES=YES;RUN;data produit;set gestion;keep codprod libprod produit branche anpere type_produit systeme;run;proc sort data=produit nodupkey;by codprod;run;/********************************************************************************//*   1A : Recuperation des PM sur RCV         *//********************************************************************************/%recup_pm_rcv(an=&an.,mois=&mois.,no_lancement=1,pole=AA,table=RCVPM);%recup_pm_rcv(an=&an.,mois=&mois.,no_lancement=2,pole=CO,table=RCVPM);%recup_pm_rcv(an=&an.,mois=&mois.,no_lancement=3,pole=CU,table=RCVPM);data pm_rcv&an.&mois.;set pm1 pm2 pm3;format police $30.;police=trim(left(put(numctv,$30.)));format code_support $30.;code_support=codsup;if codprod in ("FC 02" "FC 05" "FC 12" "FC 15" "FC 22" "FC 25") then do; if codsup in ('KID' 'KIE' 'KIP') then do; /* Le produit Expantiel Initiative a le même code produit que Expantiel, il est possible de les differencier avec les support */  libprod='EXPANTIEL INITIATIVE';  produit='EXPANTIEL INITIATIVE';  anpere='NON'; end; else if dtemi<19990400 then do;  libprod='EXPANTIEL 1e';  anpere='NON'; end;end;drop codsup; run;/* On cree ici la table donnant le type de gestion par contrat au dernier mois connu, cette information sera ajoutee a la table de flux */data gestion_pm_rcv;set pm_rcv&an.&mois.(keep=numctv mois type_gestion_long type_gestion gestion libprod produit branche dteff dtemi codport reseau datnai1 datnai2 anpere type_produit systeme codsociete);run;proc sort data=gestion_pm_rcv nodupkey;by numctv descending mois;run;data gestion_pm_rcv;set gestion_pm_rcv;by numctv;if first.numctv then output;run;/******************************************************************************************************************************************//******************************************************************************************************************************************//********************************************************************************//*   2A : Recuperation des PM sur NOVA         *//********************************************************************************/%recup_pm_nova(an=&an.,mois=&mois.,no_lancement=1,pole=AA,table=VISTAINV);%recup_pm_nova(an=&an.,mois=&mois.,no_lancement=2,pole=CO,table=VISTAINV);%recup_pm_nova(an=&an.,mois=&mois.,no_lancement=3,pole=CU,table=VISTAINV);%recup_pm_nova(an=&an.,mois=&mois.,no_lancement=4,pole=RS,table=VISTAINV);%recup_pm_nova(an=&an.,mois=&mois.,no_lancement=5,pole=AA,table=VISDTINV);%recup_pm_nova(an=&an.,mois=&mois.,no_lancement=6,pole=AA,table=ILISINV);%recup_pm_nova(an=&an.,mois=&mois.,no_lancement=7,pole=CO,table=ILISINV);%recup_pm_nova(an=&an.,mois=&mois.,no_lancement=8,pole=CU,table=ILISINV);%recup_pm_nova(an=&an.,mois=&mois.,no_lancement=9,pole=RS,table=ILISINV);%recup_pm_nova(an=&an.,mois=&mois.,no_lancement=10,pole=AA,table=ILDTINV);%recup_pm_nova(an=&an.,mois=&mois.,no_lancement=11,pole=AA,table=AGIPI);%recup_pm_nova(an=&an.,mois=&mois.,no_lancement=12,pole=CO,table=AGIPI);/**end **/data pm_nova&an.&mois.;set pm1 pm2 pm3 pm4 pm5 pm6 pm7 pm8 pm9 pm10 pm11 pm12;format police $30.;police=trim(left(put(numctv,$30.))); format code_support $30.;code_support=codsup;drop codsup;run;proc datasets library = rmtwork;    DELETE temp_pms temp_pm pm pm1 pm2 pm3 pm4 pm5 pm6 pm7 pm8 pm9 pm10 pm11 pm12;run;data _null_;run;/********************************************************************************//*   2A : Recuperation des Flux sur NOVA (même macro que sur RCV)   *//********************************************************************************/%recup_flux_nova(an=&an.,mois=&mois.,no_lancement=1,pole=AA,table=VISTAINV);%recup_flux_nova(an=&an.,mois=&mois.,no_lancement=2,pole=CO,table=VISTAINV);%recup_flux_nova(an=&an.,mois=&mois.,no_lancement=3,pole=CU,table=VISTAINV);%recup_flux_nova(an=&an.,mois=&mois.,no_lancement=4,pole=RS,table=VISTAINV);%recup_flux_nova(an=&an.,mois=&mois.,no_lancement=5,pole=AA,table=VISDTINV);%recup_flux_nova(an=&an.,mois=&mois.,no_lancement=6,pole=AA,table=ILISINV);%recup_flux_nova(an=&an.,mois=&mois.,no_lancement=7,pole=CO,table=ILISINV);%recup_flux_nova(an=&an.,mois=&mois.,no_lancement=8,pole=CU,table=ILISINV);%recup_flux_nova(an=&an.,mois=&mois.,no_lancement=9,pole=RS,table=ILISINV);%recup_flux_nova(an=&an.,mois=&mois.,no_lancement=10,pole=AA,table=ILDTINV);%recup_flux_nova(an=&an.,mois=&mois.,no_lancement=11,pole=AA,table=AGIPI);%recup_flux_nova(an=&an.,mois=&mois.,no_lancement=12,pole=CO,table=AGIPI);data flux_nova&an.&mois.;set flux1 flux2 flux3 flux4 flux5 flux6 flux7 flux8 flux9 flux10 flux11 flux12;format police $30.;police=trim(left(put(numctv,$30.)));format code_support $30.;code_support=codsup;drop codsup;run;proc sort data=flux_nova&an.&mois.;by codprod;run;data flux_nova&an.&mois.;merge flux_nova&an.&mois.(in=a) produit(in=b);by codprod;if a;run;proc sort data=flux_nova&an.&mois.;by code_support;run;data flux_nova&an.&mois.;merge flux_nova&an.&mois.(in=a) support(in=b);by code_support;if a;if type='E' then support='EURO';else support='UC';montant_brut_uc=0;if support='UC' then montant_brut_uc=montant_brut;drop type;run;data gestion_pm_nova;set pm_nova&an.&mois.(keep=numctv mois type_gestion_long type_gestion gestion libprod produit anpere type_produit systeme branche codsociete);run;proc sort data=gestion_pm_nova nodupkey;by numctv descending mois;run;data gestion_pm_nova;set gestion_pm_nova;by numctv;if first.numctv then output;run;data gestion_pm;set gestion_pm_nova gestion_pm_rcv(keep=numctv mois type_gestion_long type_gestion gestion libprod produit branche anpere type_produit systeme codsociete);run;proc sort data=gestion_pm nodupkey;by numctv descending mois;run;data gestion_pm;set gestion_pm;by numctv;if first.numctv then output;run;  /** !!! etape délicate -> executer à part !!! **/proc sort data=flux_nova&an.&mois.;by numctv;run;data flux_nova&an.&mois.;merge flux_nova&an.&mois.(in=a) gestion_pm(in=b drop=mois);by numctv;if a and b;run;        /**                   end                    **/proc datasets library = rmtwork;    DELETE temp_flux_mvs temp_flux_mv flux1 flux2 flux3 flux4 flux5 flux6 flux7 flux8 flux9 flux10 flux11 flux12 gestion_pm_nova gestion_pm_rcv;run;/********************************************************************************//*   3A : Recuperation des PM sur AXV4         *//********************************************************************************/%recup_pm_axv4(an=&an.,mois=&mois.)proc sort data=pm_axv4; by codprod mandat_de_gestion_collectif mandat_de_gestion_personnalise;run;proc sort data=gestion; by codprod mandat_de_gestion_collectif mandat_de_gestion_personnalise;run;data pm_axv4;merge pm_axv4(in=a) gestion(in=b keep=codprod libprod mandat_de_gestion_collectif MANDAT_DE_GESTION_PERSONNALISE produit type_gestion_long type_gestion gestion branche systeme type_produit anpere);by codprod mandat_de_gestion_collectif mandat_de_gestion_personnalise;if a;run;data corr_gestion;set pm_axv4;where pm>0 and gestion='GSM';top=1;keep police top;run;proc sort data=pm_axv4;by police;run;proc sort data=corr_gestion nodupkey;by police;run;data pm_axv4;merge pm_axv4(in=a) corr_gestion(in=b);by police;if a;if top=1 then gestion='GSM';drop top;run;data pm_axv4&an.&mois.;set pm_axv4(drop=mandat_de_gestion_collectif MANDAT_DE_GESTION_PERSONNALISE nom_produit);format code_support $30.;code_support=code_isin;run;/********************************************************************************//*   3B : Recuperation des Flux sur AXV4         *//********************************************************************************/%recup_flux_axiomev4(an=&an.,mois=&mois.,out=flux_axv4);data flux_axv4&an.&mois.;set flux_axv4;format code_support $30.;code_support=code_isin;run;data gestion_pm_axv4;set pm_axv4&an.&mois.(keep=police mois type_gestion_long type_gestion gestion branche libprod produit dteff dtemi codport datnai1 systeme type_produit anpere codsociete cumul_prime_verse);run;proc sort data=gestion_pm_axv4 nodupkey;by police descending mois;run;data gestion_pm_axv42;set gestion_pm_axv4;by police;if first.police then output;run;proc datasets library = rmtwork;    DELETE gestion_pm_axv4;run;proc sort data=flux_axv4&an.&mois.;by codprod;run;data flux_axv4&an.&mois.;merge flux_axv4&an.&mois.(in=a) produit(in=b);by codprod;if a;run;proc sort data=flux_axv4&an.&mois.;by police;run;data flux_axv4&an.&mois.;merge flux_axv4&an.&mois.(in=a) gestion_pm_axv42(in=b drop=mois);by police;if a;run;/********************************************************************************//*   4A : Recuperation des PM sur AXV1         *//********************************************************************************/%recup_pm_axv1(an=&an.,mois=&mois.)data pm_axv1&an.&mois.;set pm_axv1;format code_support $30.;code_support=code_isin;run;proc sort data=pm_axv1&an.&mois.;by codprod mandat_de_gestion;run;proc sort data=gestion;by codprod mandat_de_gestion;run;data pm_axv1&an.&mois.(drop=mandat_de_gestion);merge pm_axv1&an.&mois.(in=a) gestion(in=b keep=codprod mandat_de_gestion type_gestion gestion produit branche libprod type_gestion_long systeme type_produit anpere);by codprod mandat_de_gestion;if a;run;/********************************************************************************//*   4B : Recuperation des Flux sur AXV1         *//********************************************************************************/%recup_flux_axiomev1(an=&an.,mois=&mois.,out=flux_axv1);data flux_axv1&an.&mois.;set flux_axv1;format code_support $30.;code_support=code_isin;run;data gestion_pm_axv1;set pm_axv1&an.&mois.(keep=police mois type_gestion_long type_gestion gestion reseau libprod produit dteff dtemi codport datnai1 systeme type_produit anpere branche codsociete);run;proc sort data=gestion_pm_axv1 nodupkey;by police descending mois;run;data gestion_pm_axv12;set gestion_pm_axv1;by police;if first.police then output;run;proc datasets library = rmtwork;    DELETE gestion_pm_axv1;run;proc sort data=flux_axv1&an.&mois.;by codprod;run;data flux_axv1&an.&mois.;merge flux_axv1&an.&mois.(in=a) produit(in=b);by codprod;if a;run;proc sort data=flux_axv1&an.&mois.;by police;run;data flux_axv1&an.&mois.;merge flux_axv1&an.&mois.(in=a) gestion_pm_axv12(in=b drop=mois);by police;if a;run;proc datasets library = rmtwork;    DELETE corr_gestion flux flux_axv1 flux_axv4 pm_axv1 pm_axv4;run;/*******************************************************************************************************************************************************************/  /******************************************************************/  /*                        Reporting                               */  /******************************************************************//*PM par support*/%pm_sup(an=&an.,mois=&mois.,systeme=nova);%pm_sup(an=&an.,mois=&mois.,systeme=rcv);%pm_sup(an=&an.,mois=&mois.,systeme=axv1);%pm_sup(an=&an.,mois=&mois.,systeme=axv4);data pm_support; set pm_nova_sum pm_rcv_sum pm_axv1_sum pm_axv4_sum;run;data pm_globale; set pm_nova_contrat_sum pm_rcv_contrat_sum pm_axv1_contrat_sum pm_axv4_contrat_sum;run;proc export data=pm_support    OUTFILE= "~/NAS/M/eQUIPES/Produits & Normes/Statistiques_Produits&an.&mois..xlsx"     DBMS=xlsx REPLACE;     sheet="pm_support";     run;proc export data=pm_globale  OUTFILE= "~/NAS/M/eQUIPES/Produits & Normes/Statistiques_Produits&an.&mois..xlsx"     DBMS=xlsx REPLACE;     sheet="pm_globale";     run;proc datasets library = rmtwork;    DELETE pm_nova pm_rcv pm_axv1 pm_axv4 pm_nova_sum pm_rcv_sum pm_axv1_sum pm_axv4_sum pm_nova pm_rcv pm_axv1 pm_axv4 pm_nova_contrat pm_rcv_contrat pm_axv1_contrat pm_axv4_contrat pm_nova_contrat_sum pm_rcv_contrat_sum pm_axv1_contrat_sum pm_axv4_contrat_sum;run;data _null_;run;/*flux par support*/%let mouvement=AN-VL-PP-AS-AE-RG-RP-RT-SI-E;%flux_sup(an=&an.,mois=&mois.,systeme=nova);%flux_sup(an=&an.,mois=&mois.,systeme=axv1);%flux_sup(an=&an.,mois=&mois.,systeme=axv4);data flux_support; set flux_nova_sum flux_axv1_sum flux_axv4_sum; production=an+vl+pp; production_uc=an_uc+vl_uc+pp_uc;run;data flux_global; set flux_nova_5 flux_axv1_5 flux_axv4_5;run;proc export data=flux_support     OUTFILE= "~/NAS/M/eQUIPES/Produits & Normes/Statistiques_Produits&an.&mois..xlsx"     DBMS=xlsx REPLACE;     sheet="flux_support";     run;proc export data=flux_global     OUTFILE="~/NAS/M/eQUIPES/Produits & Normes/Statistiques_Produits&an.&mois..xlsx"     DBMS=xlsx REPLACE;     sheet="flux_global";     run;proc datasets library = rmtwork;    DELETE flux_nova flux_axv1 flux_axv4 flux_nova_sum flux_axv1_sum flux_axv4_sum engagement_annuel gestion gestion_pm_axv12 gestion_pm_axv42;run;/*data _null_;run;data test;set flux_nova1609 flux_axv11609 flux_axv41609;where libprod="ARPEGES" and reseau="AGENTS GENERAUX" and mvt="AN" and type_gestion_long="CONVENTION PRéCAUTION +" and dteff>20160700;run;proc sort data=test; by type_gestion_long;run;proc summary data=test;by type_gestion_long;var pm;id numctv ;output out=res (drop=_type_) sum=;run;data test2;set test;where numctv=9105770604;run;*/data central.flux_nova1610;set flux_nova1610;run;data central.pm_nova1610;set pm_nova1610;run;
