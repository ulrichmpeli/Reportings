  /*----------------------------------------------*/ /*    Mise à jour des BD     *//*----------------------------------------------*//* !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! *//* Ne pas lancer la partie concernant le produit Cisélium si l'année et le mois du reporting sont antérieurs au mois de juillet 2009 *//* Mettre à jour le fichier Anciens et Nouveaux Protocoles *//* Les variables aa et aa_aa doivent contenir la même valeur */%let user_id=s623483;%let user_mdp=44ekjrna;%let lettre_serveur=M;%let mm=11; /* mois du reporting */%let aa=16; /* année du reporting */%let aa_aa=20&aa.; /* même année que précédemment *//* Déclaration des variables pour l'exportation finale des fichiers "Détail" et "Synthèse" */%let chemin_export = ~/NAS/M/eQUIPES/Produits & Normes/Nguyen_K/Reporting courtage/Reporting Courtage/Extractions/2016;%let nom_fiche = Details Produits Courtage ; %let nom_fiche_synt = Synthese Produits Courtage ;/* !! X correspond au serveur : prnas01/5b/chnrs2_actuariat, à modifier si lettre différente !! *//* Création des librairies *//*libname flux "/mutu/FR/batch/data/prod/IF12/VIE/IAF300/AXIOFLUX/M&aa&mm";libname NACTFLUX "/mutu/FR/batch/data/prod/IF12/VIE/ICU300/VISTAINV/M&aa&mm";libname FLUXCUM "/mutu/FR/batch/data/prod/IF12/VIE/ICU300/VISTAINV/FLUX/M20&aa&mm";libname v4Flux"/mutu/FR/batch/data/prod/IF12/VIE/IAF160/SAXO/INVFLUX/M20&aa&mm";libname inv "/mutu/FR/batch/data/prod/IF12/VIE/IAF160/SAXO/INVSTOCK/A2011";*/libname pm "/mutu/FR/batch/data/prod/IF12/VIE/IAF300/AXIOMINV/M&aa&mm";libname NACT "/mutu/FR/batch/data/prod/IF12/VIE/ICU300/NACT/M20&aa&mm";libname rcv "/mutu/FR/batch/data/prod/IF12/VIE/ICU300/RCVPM/M&aa&mm";libname stock "/mutu/FR/batch/data/prod/IF12/VIE/IAF160/SAXO/INVSTOCK/M20&aa&mm";libname tempo "~/NAS/&lettre_serveur./eQUIPES/Produits & Normes/Nguyen_K/Reporting courtage/Reporting Courtage/Tables/Temporaire/";/* La librairie "tempo" est à vider après chaque reporting La librairie work n'a pas été utilisée parceque vu la taille des tables, celle ci a tendance à saturer */  /*--------------------------------------------------------------*/ /*      MACROS du programme       *//*--------------------------------------------------------------*//* Macro permettant de remplacer les . par des 0 dans une table donnée */%Macro M_Zero (table_in,table_out) ;     data &table_out (drop=_i);          set &table_in ;          array A_VarNum[*] _NUMERIC_ ;                do _i=1 to dim( A_VarNum ) ;          If A_VarNum (_i)=. then A_VarNum (_i)=0 ;     End ;   run ;%Mend ;/* Macro permettant de Ranger une table par une variable choisie */%Macro rangement1(table,var);  proc sort data=&table;  by &var;  run;%Mend;/* Macro permettant de concaténer deux tables par une variable choisie avec condition de la deuxième table */%macro concat_condition2(table_in_1,table_in_2,table_out,var,table);data &table_out;merge &table_in_1 (in=a) &table_in_2 (in=b);by &var;if &table;run;%mend;/*Macro permettant de concaténer trois tables par une variable choisie avec condition de la première table */%Macro concat_condition3(table_in1,table_in2,table_in3,table_out,var);DATA &table_out;MERGE &table_in1 (in=a) &table_in2 (in=b) &table_in3 (in=c);BY &var;if a;RUN;%mend;/* Macro de suppression de variable */%macro supp_codprod (table_in,var);data &table_in;set &table_in;drop &var;run;%mend;/* Macro d'importation de fichier */%MACRO importation(chemin, fich, lib, feuil);PROC IMPORT OUT= &Lib..&feuil            DATAFILE= "&chemin&fich"            DBMS=XLS REPLACE;  GETNAMES=YES;RUN;%MEND importation;/* Macro d'exportation */%MACRO exportation(nom_table, chemin, nom_fich, nom_onglet, mois, annee);PROC EXPORT DATA= &nom_table    OUTFILE= "&chemin&nom_fich &mois &annee..xls"  DBMS=excelcs REPLACE;    SHEET="&nom_onglet";  SERVER="prafasasfs01.siege.axa-fr.intraxa"; SERVERUSER="SIEGE\&user_id."; SERVERPASS="&user_mdp."; PORT=8621;RUN;%MEND exportation;%MACRO exportation(nom_table, chemin, nom_fich, nom_onglet, mois, annee);PROC EXPORT DATA= &nom_table    OUTFILE= "&chemin.&nom_fich. &mois &annee..xls"  DBMS=excelcs REPLACE;    SHEET="&nom_onglet";  SERVER="prafasasfs01.siege.axa-fr.intraxa"; SERVERUSER="SIEGE\&user_id."; SERVERPASS="&user_mdp."; PORT=8621;RUN;%MEND exportation;  /*--------------------------------------------------------------*/ /*      FIN des MACROS du programme     *//*--------------------------------------------------------------*/  /*--------------------------------------------------------------*/ /*         IMPORTATION DE FICHIERS      *//*--------------------------------------------------------------*//* Importation des CODES ISIN (fichier Excel fait manuellement) pour le fichier Détail Produits Courtage */%importation(~/NAS/M/eQUIPES/Produits & Normes/Nguyen_K/Reporting courtage/Reporting Courtage/Tables/,Codes ISIN2,tempo,table_isin);/* On définit la variable CODSUP en format caractère pour la concaténation avec les autres tables */DATA tempo.Table_isin; SET tempo.Table_isin;length COD $5.;COD=CODSUP;DROP CODSUP;RENAME COD=CODSUP;RUN;%rangement1(tempo.Table_isin,CODSUP);/* On trie la table afin de la concaténer correctement avec d'autres tables *//****** Importation de 2 fichiers : Anciens et Nouveaux protocoles ******/%let source_proto=~/NAS/&lettre_serveur./eQUIPES/Produits & Normes/Nguyen_K/Reporting courtage/Reporting Courtage/Tables/;/* !! A modifier si fichier plus récent disponible */%let fich_ancien_proto=Anciens Protos au 31-12-2010 vu au 17_01_11.xls;%let fich_nouveau_proto=Nouveaux Protos au 31-12-2010 vu au 17_01_11.xls;/* Ancien Proto */%importation(&source_proto,&fich_ancien_proto,tempo,ancien_proto);%rangement1(tempo.ancien_proto,Code_Cabinet);data tempo.ancien_proto;set tempo.ancien_proto;Ann_e_saisie_ancien_proto=year(Date_Debut_Protocole);drop Date_Debut_Protocole;run;%M_zero(tempo.ancien_proto,tempo.ancien_proto);/* Nouveau Proto */%importation(&source_proto,&fich_nouveau_proto,tempo,nouveau_proto);data tempo.nouveau_proto;set tempo.nouveau_proto;Sans_Avenantb=Sans_Avenant*1;Avenant_Vie_75_keb=Avenant_Vie_75ke*1; Avenant_Vie_150_keb=Avenant_Vie_150ke*1;Avenant_Vie_300_keb=Avenant_Vie_300ke*1;Avenant_Vie_600_keb=Avenant_Vie_600ke*1;Avenant_Vie_1000_keb=Avenant_Vie_1000ke*1;Avenant_Vie_4_Meb=Avenant_Vie_4Me*1;Avenant_Vie_6_Meb=Avenant_Vie_6Me*1;Triaction_1_5_Mb=Triaction_1_5M*1;Triaction_2_5_Mb=Triaction_2_5M*1;drop REGION Sans_Avenant Avenant_Vie_75ke Avenant_Vie_150ke Avenant_Vie_300ke Avenant_Vie_600ke Avenant_Vie_1000ke Avenant_Vie_4Me Avenant_Vie_6Me Triaction_1_5M Triaction_2_5M;run;data tempo.nouveau_proto;set tempo.nouveau_proto;Code_cabinet2 = (Code_cabinet-98);Code_cabinet2= Code_cabinet2/100;drop Code_cabinet;rename Code_cabinet2=Code_cabinet Sans_Avenantb=Sans_Avenant Avenant_Vie_75_keb=Avenant_Vie_75_ke Avenant_Vie_150_keb=Avenant_Vie_150_ke Avenant_Vie_300_keb=Avenant_Vie_300_ke Avenant_Vie_600_keb=Avenant_Vie_600_ke Avenant_Vie_1000_keb=Avenant_Vie_1000_ke Avenant_Vie_4_Meb=Avenant_Vie_4_Me Avenant_Vie_6_Meb=Avenant_Vie_6_Me Triaction_1_5_Mb=Triaction_1_5_M Triaction_2_5_Mb=Triaction_2_5_M;run;%M_zero(tempo.nouveau_proto,tempo.nouveau_proto);%rangement1(tempo.nouveau_proto,Code_cabinet);/* Compter pour vérifier si les fichiers sont bien importés */proc sql;create table tempo.compter_nouveau (Sans_Avenant num,Avenant_Vie_75_ke num,         Avenant_Vie_150_ke num, Avenant_Vie_300_ke num,         Avenant_Vie_600_ke num, Avenant_Vie_1000_ke num        ,Avenant_Vie_4_Me num, Avenant_Vie_6_Me num        ,Triaction_1_5_M num, Triaction_2_5_M num);insert into tempo.compter_nouveauselect  sum(Sans_Avenant) as Sans_Avenant,  sum(Avenant_Vie_75_ke)as Avenant_Vie_75_ke,  sum(Avenant_Vie_150_ke) as Avenant_Vie_150_ke,  sum(Avenant_Vie_300_ke) as Avenant_Vie_300_ke,  sum(Avenant_Vie_600_ke) as Avenant_Vie_600_ke,  sum(Avenant_Vie_1000_ke) as Avenant_Vie_1000_ke,  sum(Avenant_Vie_4_Me) as Avenant_Vie_4_Me,  sum(Avenant_Vie_6_Me) as Avenant_Vie_6_Me,  sum(Triaction_1_5_M) as Triaction_1_5_M,  sum(Triaction_2_5_M) as Triaction_1_5_M  from (select Sans_Avenant ,Avenant_Vie_75_ke ,         Avenant_Vie_150_ke , Avenant_Vie_300_ke ,         Avenant_Vie_600_ke , Avenant_Vie_1000_ke         ,Avenant_Vie_4_Me , Avenant_Vie_6_Me         ,Triaction_1_5_M , Triaction_2_5_M from tempo.nouveau_proto);quit;/* --> Vérification OK au 12 Jan 2010 *//* Si Erreur, remplacer dans le fichier Excel source tous les blancs par des 0 dans les colonnes I à R *//******** Importation produits ILIS associatifs ********/%let source_ilis=~/NAS/M/eQUIPES/Produits & Normes/Nguyen_K/Reporting courtage/Reporting Courtage/Tables/;/* !! A modifier si fichier plus récent disponible*/%let fich_ilis=Liste des produits ILIS associatifs 10 03.xls;%importation(&source_ilis,&fich_ilis,tempo,ILIS_asso);data tempo.ilis_asso_bis;set tempo.ilis_asso;cod=put(UV,5.0);asso="asso";rename cod=codprod;run;data tempo.ilis_asso_bis;set tempo.ilis_asso_bis;keep codprod asso;run;%rangement1(tempo.ilis_asso_bis,codprod);/******** Importation des Bases distributeurs ********//** RCV et NOVA **/%let source_bd=~/NAS/&lettre_serveur./eQUIPES/Produits & Normes/Nguyen_K/Reporting courtage/Reporting Courtage/Tables/;libname BD "~/NAS/&lettre_serveur./eQUIPES/Produits & Normes/Nguyen_K/Reporting courtage/Reporting Courtage/Tables/";%let fich_BD=BD &mm&aa;%let fich_BD_Axiva=BD_axiva &mm&aa;/* Si erreur dans l'importation vérifier que les fichiers sont disponibles et formatés (cf doc Procédure Création BD SAS)*/%importation(&source_bd,&fich_BD,BD,Bd&mm&aa);data tempo.Bd&mm&aa;set BD.Bd&mm&aa;code = Code_ptf * 1;code_cabin = Code_cabinet * 1;code_court = Code_Courtier * 1;if code=. then delete;drop Code_ptf Code_cabinet Code_Courtier;rename code = Code_ptf  code_cabin = Code_cabinet code_court = Code_Courtier;run;proc sort data=tempo.Bd&mm&aa;by Code_Courtier;run;proc sort data=tempo.Bd&mm&aa nodupkey;by Code_ptf;run;%importation(&source_bd,&fich_BD_Axiva,BD,Bd_axiva_&mm&aa);data tempo.Bd_axiva_&mm&aa;set BD.Bd_axiva_&mm&aa;run;%rangement1(tempo.Bd&mm&aa,Code_ptf);/** Axiome **/%let chemin_sources=~/NAS/&lettre_serveur./eQUIPES/Produits & Normes/Nguyen_K/Reporting courtage/Reporting Courtage/Tables/;%let fich = Reporting Capital Ressources Courtiers_V2 ;%let feuil = Repor_Capi;%importation (&chemin_sources,&fich,tempo,&feuil);%M_Zero(tempo.Repor_Capi,tempo.Repor_Capi);%rangement1(tempo.Repor_Capi,N_contrat);/*--------------------------------------------------------------*//*          FIN FICHIERS importés     *//*--------------------------------------------------------------*//*---------------------------------------------------------------------*//*   Récupération et Traitements des données par système de gestion    *//*---------------------------------------------------------------------*//*--------------------*//*         RCV        *//*--------------------*//* Récupération des données nécessaires ventilées par contrat (table pm) */DATA tempo.RCVpm&mm&aa;SET rcv.pm; keep NUMCTV codport CODPROD TYPCOT region reseau DTEFFCODETA DATECH DATNAIS CODQSOU NOMABR CODPOS ;format NUMCTV best16.;run;/* Récupération des données nécessaires ventilées par contrat et support (table pms) */DATA tempo.RCVpms&mm&aa;SET rcv.pms;keep NUMCTV CODUC CODSUP RESF codport;rename codport=Code_ptf;format NUMCTV best16.;run;/* Récupération des libellés produits et support (fichier Excel) */libname vie   "/mutu/FR/batch/data/prod/IF12/VIE/IAA300/TABVIE";data tempo.Lib_Prod_Support;set vie.viestc;run;Data tempo.Lib_Prod_Support;set tempo.Lib_Prod_Support;keep CODPROD CODSUP LIBPROD LIBSUPP NAT_SUPP;run;/* Agrégation des données nécessaires RCV */proc sql ;create table tempo.Table_RCV0_&mm&aa asselect * from tempo.RCVpm&mm&aa B1, tempo.RCVpms&mm&aa B2, tempo.Lib_Prod_Support ProdSupwhere ((B1.NUMCTV=B2.NUMCTV) and (B1.CODPROD=ProdSup.CODPROD and B2.CODSUP=ProdSup.CODSUP)) ;quit;data tempo.Table_RCV0_&mm&aa;set tempo.Table_RCV0_&mm&aa;if NAT_SUPP="EURO" then Support="EURO";if (CODUC<>"000" and CODUC<>"099" and Support="") THEN Support ="UC";else Support = "EURO";run;%M_Zero(tempo.Table_RCV0_&mm&aa,tempo.Table_RCV0_&mm&aa);/**//*correction sur des noms de produit différent avec le même numéro de contrat - TEMPO et TEMPO AJUST AUTO */Data tempo.doublon;set tempo.Table_RCV0_&mm&aa;cp1=1;cp2=1;run;proc sort data=tempo.doublon;by NUMCTV LIBPROD; run;proc means data = tempo.doublon noprint;var cp1 ;by NUMCTV LIBPROD;OUTPUT OUT=tempo.Table_RCV0a (drop=_type_ _freq_)SUM=;RUN;proc means data = tempo.doublon noprint;var cp2 ;by NUMCTV;OUTPUT OUT=tempo.Table_RCV0b (drop=_type_ _freq_)SUM=;RUN;proc sql ;create table tempo.Table_RCV0 asselect * from tempo.Table_RCV0_&mm&aa Base, tempo.Table_RCV0a A, tempo.Table_RCV0b B where ((Base.NUMCTV=A.NUMCTV) and (Base.LIBPROD=A.LIBPROD)) and (Base.NUMCTV=B.NUMCTV) ;quit;/* Fin correction */data tempo.Table_RCV0;set tempo.Table_RCV0;/*if (cp1<>cp2 and LIBPROD="TEMPORAIRE") then LIBPROD="TEMPORAIRE AJUST AUTO";*/where (substr(LIBPROD,1,10)<>"TEMPORAIRE" and substr(LIBPROD,1,5)<>"MIXTE" and substr(LIBPROD,1,11)<>"VIE ENTIERE");drop NAT_SUPP;run;/* Table RCV avant de regrouper avec la table BD */DATA tempo.Table_RCV2;SET tempo.Table_RCV0;length Type_Rachat $20;length Etat $35;Code_ptf=codport-4;DATNAISb=put(DATNAIS,8.);DATECHb=put(DATECH,8.);Civilite=CODQSOU;Nom_Client=NOMABR;PM=RESF;if (MVT in ("CT","TE","VL","VLP","R","RP","RPP") and (cp2=1 or CODSUP=SUPANC or (SUPANC="GP" and (substr(CODPROD,1,2)=substr(CODSUP,1,2) /*or CODSUP="088" or CODSUP="089"*/) and PM>MtMVT)) /*or (SUPANC="" and CODSUP="089")*/) then do; if (MVT="CT") then VI=MtMVT;else VI=0; if (MVT="TE") then VC=MtMVT;else VC=0; if (MVT in ("VL","VLP")) then VLP=MtMVT;else VLP=0; if (MVT in ("R","RP","RPP")) then Rachat=MtMVT;else Rachat=0;end;somme=VI+VC+VLP+Rachat;if (MVT="R") then Type_Rachat="Rachat total";/**/date_effet = substr(DTEFF,7,2)||'/'||substr(DTEFF,5,2)||'/'||substr(DTEFF,1,4);date_ech = substr(DATECHb,7,2)||'/'||substr(DATECHb,5,2)||'/'||substr(DATECHb,1,4);age=&aa_aa-substr(DATNAISb,1,4);IF Codeta="EV" THEN Etat="En vigueur";else IF Codeta="LC" THEN Etat="Libéré de cotisations";else IF Codeta="RD" THEN Etat="Réduit";else Etat="";DROP CODPORT DATNAIS DATNAISb DTEFF DATECH DATECHb RESF CODQSOU NOMABR CODETA;RUN;/**** Contrôle des montants de flux avant et après traitement des bases ****/proc sort data=tempo.Table_RCV2;by NUMCTV; run;/* Base Flux uniquement */DATA tempo.Base1;set tempo.Table_RCV2;by NUMCTV;if first.NUMCTV then output;keep NUMCTV;run;/* Base Flux une fois croisée avec la table contrat/support */proc summary data = tempo.Table_RCV2;var somme;by NUMCTV;OUTPUT OUT=tempo.BaseRCVTot (drop=_type_ _freq_)SUM=;RUN;data tempo.BaseVerif;set tempo.BaseRCVTot;if (MtMVT=somme) then Verif="Ok  ";else Verif="Prob";run;proc freq data=tempo.BaseVerif;table Verif;where somme<>.;run;proc means data=tempo.BaseVerif sum;  var MtMVT somme;run;/**** Fin des contrôles ****/proc sql;create table tempo.Table_RCV3 asselect * from tempo.Table_RCV2 B1 LEFT JOIN tempo.BaseVerif B2on (B1.NUMCTV=B2.NUMCTV) ;quit;%M_zero(tempo.Table_RCV3,tempo.Table_RCV3);%rangement1(tempo.Table_RCV3,Code_ptf);%rangement1(tempo.Bd&mm&aa,Code_ptf);%concat_condition2(tempo.Bd&mm&aa,tempo.Table_RCV3,tempo.Table_RCV4,Code_ptf,b);%M_zero(tempo.Table_RCV4,tempo.Table_RCV4);data tempo.Table_RCV4;set tempo.Table_RCV4;num=put(NUMCTV,16.);if (MVT="CT" and Verif="Prob") then VI=999999999;if (MVT="TE" and Verif="Prob") then VC=999999999;if (MVT in ("VL","VLP") and Verif="Prob") then VLP=999999999;if (MVT in ("R","RP","RPP") and Verif="Prob") then Rachat=999999999;keep Code_courtier Raison_sociale_courtier Code_cabinet Raison_sociale_cabinet Prenom_Inspecteur codprod Nom_Inspecteur LIBPROD num date_effet date_ech CODUC Support LIBSUPP VI VC VLP PM Rachat Type_Rachat Civilite Nom_Client libelle_region reseau Type_Inspecteur Etat age Code_ptf;run;proc sort data = tempo.Table_RCV4;by Code_courtier Raison_sociale_courtier Code_cabinet Raison_sociale_cabinetcodprod LIBPROD NUM date_effet date_ech CODUC Support LIBSUPP Type_RachatCivilite Nom_Client libelle_region reseau Type_Inspecteur Etat age Code_ptfPrenom_Inspecteur Nom_Inspecteur;run;proc summary data = tempo.Table_RCV4;var VI VC VLP PM Rachat;by Code_courtier Raison_sociale_courtier Code_cabinet  Raison_sociale_cabinetcodprod LIBPROD NUM date_effet date_ech CODUC Support LIBSUPP Type_RachatCivilite Nom_Client libelle_region reseau Type_Inspecteur Etat age Code_ptfPrenom_Inspecteur Nom_Inspecteur;OUTPUT OUT=tempo.Table_RCV5 (drop=_type_ _freq_)SUM=;RUN;data tempo.table_RCV5;set tempo.table_RCV5;if (VI>=999999999 or VC>=999999999 or VLP>=999999999 or Rachat>=999999999) then do;if (VI>=999999999) then a="Flux VI "; else a="Flux ";if (VC>=999999999) then b=catx(" ",a," VC "); else b=catx(" ",a,"");if (VLP>=999999999) then c=catx(" ",b,"VLP "); else c=catx(" ",b,"");if (Rachat>=999999999) then InfoFlux_VI_VC_VLP_Rachat=catx(" ",c," Rachat non traités"); else InfoFlux_VI_VC_VLP_Rachat=catx(" ",c," non traités");end;Arbitrage_Entree="Flux non dispo."; /*Pas d'info*/Arbitrage_Sortie="Flux non dispo."; /*Pas d'info*/Frais_VI="Flux non dispo."; /*Pas d'info*/Frais_VC="Flux non dispo."; /*Pas d'info*/Frais_VLP="Flux non dispo."; /*Pas d'info*/drop a b c;run;proc freq data=tempo.table_rcv5;table InfoFlux_VI_VC_VLP_Rachat;run;/* Concaténation la table "Table_RCV6" avec les tables : Anciens et Nouveaux Protocoles */%rangement1(tempo.Table_RCV5,Code_cabinet);%concat_condition3(tempo.Table_RCV5,tempo.nouveau_proto,tempo.ancien_proto,tempo.Table_RCV6,Code_cabinet);%M_zero(tempo.Table_RCV6,tempo.Table_RCV6);data tempo.Table_RCV6;         set tempo.Table_RCV6;           length Avenant $30;if (VI>=999999999) then VI="";if (VC>=999999999) then VC="";if (VLP>=999999999) then VLP="";if (Rachat>=999999999) then Rachat="";IF Sans_Avenant=1 THEN Avenant="Nvelle convention sans Avenant";IF Avenant_Vie_75_ke=1 THEN Avenant="Avenant Vie 75ke";IF Avenant_Vie_150_ke=1 THEN Avenant="Avenant Vie 150ke";IF Avenant_Vie_300_ke=1 THEN Avenant="Avenant Vie 300ke";IF Avenant_Vie_600_ke=1 THEN Avenant="Avenant Vie 600ke";IF Avenant_Vie_1000_ke=1 THEN Avenant="Avenant Vie 1000ke";IF Avenant_Vie_4_Me=1 THEN Avenant="Avenant Vie 4Me";IF Avenant_Vie_6_Me=1 THEN Avenant="Avenant Vie 6Me";IF Triaction_1_5_M=1 THEN Avenant="Avenant Vie 1,5Me";IF Triaction_2_5_M=1 THEN Avenant="Avenant Vie 2,5Me";if ANNE_PROTOCOLE=0 and Ann_e_saisie_ancien_proto^=0 then Annee_proto = Ann_e_saisie_ancien_proto;if ANNE_PROTOCOLE^=0 then Annee_proto = ANNE_PROTOCOLE;if ANNE_PROTOCOLE=0 and Ann_e_saisie_ancien_proto=0 then Annee_proto =0;if Avenant = "" and Libelle_Du_Protocole ^="" then Avenant = Libelle_Du_Protocole;if Avenant = "" and Libelle_Du_Protocole ="" then Avenant = "NR";/* if (LIBPROD="TEMPORAIRE") then LIBPROD="TEMPORAIRE AJUST AUTO" */rename LIBPROD=Nom_Produit    Etat=Etat_Contrat    LIBSUPP=NOM_SUPPORT    CODUC=CODSUP    date_effet =DATE_EFFET_CONTRAT    date_ech=Date_terme    Nom_client=Nom_Prenom_Client    num= NUMERO_CONTRAT;keep Code_courtier Raison_sociale_courtier Code_cabinet Raison_sociale_cabinetcodprod LIBPROD NUM date_effet date_ech Support CODUC LIBSUPP VI VC VLP PM Rachat Type_RachatArbitrage_Entree Arbitrage_Sortie Civilite Nom_Client Libelle_Region reseau Type_Inspecteur Prenom_Inspecteur Nom_Inspecteur Etat Annee_proto Avenant age InfoFlux_VI_VC_VLP_Rachat Code_ptf Frais_VI Frais_VC Frais_VLP;run;%rangement1(tempo.Table_RCV6,CODSUP);DATA tempo.Table_RCV6;length NOM_SUPPORT $47.;SET tempo.Table_RCV6;RUN;DATA tempo.Table_RCV6_2;MERGE tempo.Table_RCV6 (in=b) tempo.Table_isin (in=a);BY CODSUP;if b;RUN;/***************************** Tables pour détails *****************************//* Table produit LibreEpargne */data tempo.LibreEpargne;set tempo.Table_RCV6;where substr(Nom_Produit,1,11)="LIBREPARGNE" and code_courtier<>99999;RENAME CODSUP=CODE_ISIN;run;/* Table Produit Unofi Liberté *//*data tempo.UNOFI;set tempo.Table_RCV6;where substr(Nom_Produit,1,5)="UNOFI" and code_courtier<>99999;RENAME CODSUP=CODE_ISIN;run;*//* Supprimer LIBREPARGNE ET produits de prévoyance de la table initiale */data tempo.Autres_RCV;set tempo.Table_RCV6_2;where substr(Nom_Produit,1,11)<>"LIBREPARGNE" and substr(Nom_Produit,1,10)<>"TEMPORAIRE" and substr(Nom_Produit,1,5)<>"MIXTE" and substr(Nom_Produit,1,11)<>"VIE ENTIERE" and code_courtier<>99999;RENAME ISIN=CODE_ISIN;DROP CODSUP TYPE;run;/****************************************************************************//* Pour la future table synthèse, on se remet sur le même périmetre que pour les tables de détail */data tempo.Table_RCV6;set tempo.Table_RCV6;if (VI="") then VI=999999999;if (VC="") then VC=999999999;if (VLP="") then VLP=999999999;if (Rachat="") then Rachat=999999999;where code_courtier<>99999;drop Arbitrage_Entree Arbitrage_Sortie Frais_VI Frais_VC Frais_VLP;run;PROC sort DATA=tempo.Table_RCV6;BY Code_courtier Raison_sociale_courtier Code_cabinet Raison_sociale_cabinet Libelle_region Nom_Produit NUMERO_CONTRAT DATE_EFFET_CONTRAT Date_terme Etat_Contrat NOM_SUPPORT InfoFlux_VI_VC_VLP_Rachat Civilite Nom_Prenom_Client age Avenant Annee_proto Type_Rachat reseau  Type_Inspecteur Code_ptf Prenom_Inspecteur Nom_Inspecteur ;RUN;PROC SUMMARY DATA=tempo.Table_RCV6;VAR VI VC VLP PM ;BY Code_courtier Raison_sociale_courtier Code_cabinet Raison_sociale_cabinet Libelle_region Nom_Produit NUMERO_CONTRAT DATE_EFFET_CONTRAT Date_terme Etat_Contrat NOM_SUPPORT InfoFlux_VI_VC_VLP_Rachat Civilite Nom_Prenom_Client age Avenant Annee_proto Type_Rachat reseau  Type_Inspecteur Code_ptf Prenom_Inspecteur Nom_Inspecteur;WHERE support="UC";OUTPUT OUT=tempo.Table_RCV7_UC (drop=_type_ _freq_) SUM=;RUN;PROC sort DATA=tempo.Table_RCV6;BY Code_courtier Raison_sociale_courtier Code_cabinet Raison_sociale_cabinet Libelle_region Nom_Produit NUMERO_CONTRAT DATE_EFFET_CONTRAT Date_terme Etat_Contrat InfoFlux_VI_VC_VLP_RachatCivilite Nom_Prenom_Client age Avenant Annee_proto Type_Rachat reseau  Type_Inspecteur Code_ptf Prenom_Inspecteur Nom_Inspecteur ;RUN;PROC SUMMARY DATA=tempo.Table_RCV6;VAR VI VC VLP PM Rachat ;BY Code_courtier Raison_sociale_courtier Code_cabinet Raison_sociale_cabinet Libelle_region Nom_Produit NUMERO_CONTRAT DATE_EFFET_CONTRAT Date_terme Etat_Contrat InfoFlux_VI_VC_VLP_RachatCivilite Nom_Prenom_Client age Avenant Annee_proto Type_Rachat reseau  Type_Inspecteur Code_ptf Prenom_Inspecteur Nom_Inspecteur;OUTPUT OUT=tempo.Table_RCV7_tot (drop=_type_ _freq_) SUM=;RUN;DATA tempo.Table_RCV7_UC;SET tempo.Table_RCV7_UC;VI_UC=VI;VC_UC=VC;VLP_UC=VLP;PM_UC=PM;drop vi vc vlp pm;run;DATA tempo.Table_RCV7;MERGE tempo.Table_RCV7_tot tempo.Table_RCV7_UC;BY Code_courtier Raison_sociale_courtier Code_cabinet Raison_sociale_cabinet Libelle_region Nom_Produit NUMERO_CONTRAT DATE_EFFET_CONTRAT Date_terme Etat_Contrat InfoFlux_VI_VC_VLP_RachatCivilite Nom_Prenom_Client age Avenant Annee_proto Type_Rachat reseau  Type_Inspecteur Code_ptf Prenom_Inspecteur Nom_Inspecteur;InfoFlux_VI_VC_VLP_RachatBis=InfoFlux_VI_VC_VLP_Rachat ;/*drop InfoFlux_VI_VC_VLP_Rachat;*/RUN;/*proc sort data=tempo.Table_RCV7 out=test/* dupout=test1 nodupkey;by NUMERO_CONTRAT;run;proc sort data=tempo.Table_RCV7 out=testbis dupout=test1 nodupkey;by NUMERO_CONTRAT;run;data test2;merge test1(in=a keep=NUMERO_CONTRAT) test(in=b);by NUMERO_CONTRAT;if a;run;*/%M_zero(tempo.Table_RCV7,tempo.Table_RCV7);/************* Table pour synthèse ***********/data tempo.table_RCV8;set tempo.table_RCV7;InfoFlux_VI_VC_VLP_Rachat=InfoFlux_VI_VC_VLP_RachatBis;Arbitrage_Entree=999999999;Arbitrage_Sortie=999999999;Frais_VI=999999999;Frais_VC=999999999;Frais_VLP=999999999;CA=VI+VC+VLP;CA_UC=VI_UC+VC_UC+VLP_UC;if (VI>=999999999) then do; VI=""; VI_UC=""; CA=""; CA_UC=""; end;if (VC>=999999999) then do; VC=""; VC_UC=""; CA=""; CA_UC=""; end;if (VLP>=999999999) then do; VLP=""; VLP_UC=""; CA=""; CA_UC=""; end;if (Rachat>=999999999) then do; Rachat=""; Rachat_UC=""; CA=""; CA_UC=""; end;if (CA)^=0 then part_CA_UC=(CA_UC)/(CA);else part_CA_UC=0;if PM ^=0 then part_PM_UC=PM_UC/PM;else part_PM_UC=0;if part_PM_UC >= (25/100) then condition_UC_PM_encours=1;else condition_UC_PM_encours=0;if PM >= 50000 then condition_PM_tot_encours=1;else condition_PM_tot_encours=0;drop InfoFlux_VI_VC_VLP_RachatBis;run;data tempo.table_RCV8;set tempo.table_RCV8;length tranche_part_PM_UC $20;length tranche_CA $60;length tranche_PM $60;If CA >= 100000 Then tranche_CA="100ke et plus";else If CA>0 and CA < 500 Then tranche_CA="0-0.5ke";else if CA=0 then tranche_CA="Pas de prod";else if CA<0 then tranche_CA="Vérif Etat du contrat ou Annulation du versement";else If CA >= 500 and CA < 1000 Then tranche_CA="0.5-1ke";else If CA >= 1000 and CA < 3000 Then tranche_CA="1-3ke";else If CA >= 3000 and CA < 20000 Then tranche_CA="3-20ke";else If CA >= 20000 and CA < 50000 Then tranche_CA="20-50ke";else If CA >= 50000 and CA < 100000 Then tranche_CA="50ke-100ke";if part_PM_UC<(10/100) then tranche_part_PM_UC="<10%";else if (part_PM_UC>=(10/100) and part_PM_UC<(25/100)) then tranche_part_PM_UC="[10%;25%[";else if part_PM_UC>=(25/100) then tranche_part_PM_UC=">=25%";If PM >= 100000 Then tranche_PM="100ke et plus";else If PM>0 and PM < 500 Then tranche_PM="0-0.5ke";else if PM=0 then tranche_PM="Pas de prod";else if PM<0 then tranche_PM="Vérif Etat du contrat ou Annulation du versement";else If PM >= 500 and PM < 1000 Then tranche_PM="0.5-1ke";else If PM >= 1000 and PM < 3000 Then tranche_PM="1-3ke";else If PM >= 3000 and PM < 20000 Then tranche_PM="3-20ke";else If PM >= 20000 and PM < 50000 Then tranche_PM="20-50ke";else If PM >= 50000 and PM < 100000 Then tranche_PM="50ke-100ke";Systeme="RCV";run;/*--------------------*//*       FIN RCV      *//*--------------------*//*--------------------*//*      AXIOME V1     *//*--------------------*//* Récupération des variables nécessaires */DATA tempo.axiva&mm&aa;SET pm.axiva;KEEP VERSEMENTS_INVESTIS_MONTANT PRIME_INVESTIE_MONTANT Numero_contrat DATE_EFFET_CONTRAT Date_terme SITUATION_CLOTURE Retraits_Montant AE_MONTANT AS_MONTANT DATE_NAISSANCE_SOUSCRIPTEUR NOM_ET_PRENOM_DU_SOUSCRIPTEURCP_RESID_FISCALE_SOUSCRIPTEUR Code_apporteur Canal_aramis CANAL_RDU Prime_brute_montant Prime_investie_montant Versements_investis_montantVersements_bruts_montant Retraits_Montant Val_acquise_clot_montant CODE_ISIN VL_CLOT NOM_SUPPORT TYPE_GARANTIE_DECES TAUX_ANNUEL_FRAIS_SUR_ENCOURS MANDAT_DE_GESTION ;DROP CODE_PORTEFEUILLE;RUN;%M_Zero(tempo.axiva&mm&aa,tempo.axiva&mm&aa);/* Conservation des canaux_aramis "0" et "000" ET des canaux_aramis_RDU "023" *//* afin de récupérer des contrats PAM dont les canaux ne sont pas affectés dans les bases *//*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*//*       2007       *//* Pour le cas où le canal_aramis="000" ET la canal_RDU="000" *//* Il y a un contrat PAM : 883/1119 dont la région n'est pas affecté *//* après avoir vérifié manuellement ce contrat appartient au courtage *//* --> conserver donc ce contrat pour le reporting à fin 2007 *//* MAIS NE PAS RAJOUTER le cas où le canal_aramis="000" ET la canal_RDU="000" *//* puisque les contrats PAM dans ce cas n'appartiennent pas forcément au courtage */ /*!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!*/DATA tempo.axiva&mm&aa;SET tempo.axiva&mm&aa;/* Permet de faire la correspondance entre le début du numéro de contrat et le produit */if substr(Numero_contrat,1,3) in ("691") Then Libel_produit="Amadeo";if substr(Numero_contrat,1,3) in ("690") Then Libel_produit="Amadeo";if substr(Numero_contrat,1,3) in ("883") Then Libel_produit="PAM";if substr(Numero_contrat,1,4) in ("1013") Then Libel_produit="PAM";/* Dans ce reporting, conservation que de PAM, PAM Capi, Amadeo & Amadeo Capi */IF Libel_produit in ("PAM" "Amadeo") AND Canal_aramis in ("230" "231" "232" "233" "234" "235") then output;if Libel_produit in ("PAM" "Amadeo") AND Canal_aramis in ("0" "000") and CANAL_RDU = "023" then output;/* Ajout du contrat 883/1119 pour le CA à fin 2007 *//*if NUMERO_CONTRAT = "883/1119" then output;*//* Correctif doublon base synthèse */where DATE_EFFET_CONTRAT<>"";run;/* Mise à zéro des cellules numériques vides */%M_zero(tempo.axiva&mm&aa,tempo.axiva&mm&aa);data tempo.axiva2&mm&aa;set tempo.axiva&mm&aa;If Canal_aramis="230" THEN Libelle_region="Ile-de-France";If Canal_aramis="231" THEN Libelle_region="Nord-Est";If Canal_aramis="232" THEN Libelle_region="Ouest";If Canal_aramis="233" THEN Libelle_region="Sud-Est";If Canal_aramis="234" THEN Libelle_region="Sud-Ouest";If Canal_aramis="235" THEN Libelle_region=" ";/* Définition manuelle des régions des contrats dont les canaux ne sont pas renseignés par leur code apporteur */if CODE_APPORTEUR = "20750" then Libelle_region="Sud-Est";if CODE_APPORTEUR = "20863" then Libelle_region="Sud-Est";/* Ajout du contrat 883/1119 pour le CA à fin 2007 */if NUMERO_CONTRAT = "883/1119" then Libelle_region="Sud-Est";/* Définir manuellement les régions de deux codes apporteurs dont les canaux ne sont pas renseignés pour le CA à fin 2007 */if CODE_APPORTEUR = "2606" then Libelle_region="Ile-de-France";if CODE_APPORTEUR = "18670" then Libelle_region="Ile-de-France";run;/* Conversion en numérique */DATA tempo.PAM_AMADEO&mm&aa;SET tempo.axiva2&mm&aa;Code_app=Code_apporteur * 1;drop Code_apporteur CANAL_RDU;run;data tempo.PAM_AMADEO&mm&aa;set tempo.PAM_AMADEO&mm&aa;RENAME Code_app=Code_apporteur;run;/* Renommer la variable */DATA tempo.PAM_AMADEO&mm&aa;set tempo.PAM_AMADEO&mm&aa;an_naissance=substr(DATE_NAISSANCE_SOUSCRIPTEUR,7,4);/* Définir les nouvelles variables *//* Prod = Prime_brute_montant + Versements_bruts_montant */VI=Prime_brute_montant;VC=Versements_bruts_montant;Frais_VI=Prime_brute_montant-Prime_investie_montant;Frais_VC=Versements_bruts_montant-Versements_investis_montant;PM = Val_acquise_clot_montant;Rachat=Retraits_Montant;Nom_Prenom_Client=NOM_ET_PRENOM_DU_SOUSCRIPTEUR;age=&aa_aa.-an_naissance;/* à remplacer 2009 par 2010 si lancé en 2010 */CP_Client=CP_RESID_FISCALE_SOUSCRIPTEUR;Arbitrage_Entree=AE_MONTANT;Arbitrage_Sortie=AS_MONTANT;Etat_Contrat=SITUATION_CLOTURE;Reseau="COURTIERS";if Etat_Contrat="contrat" then Etat_Contrat="En vigueur";if Etat_Contrat="rachete" then Etat_Contrat="Racheté";if Etat_Contrat="sanseffet" then Etat_Contrat="Sans effet";if Etat_Contrat="deces" then Etat_Contrat="Sinistré";DROP Prime_brute_montant Versements_bruts_montant Retraits_Montant Val_acquise_clot_montantNOM_ET_PRENOM_DU_SOUSCRIPTEUR CP_RESID_FISCALE_SOUSCRIPTEUR AE_MONTANT AS_MONTANT SITUATION_CLOTURE Prime_investie_montant Versements_investis_montant ;run;/* Ne conserve que : Raison_Sociale_autre_code_port='AXIVA' de la base Bd_axiva puisqu'il concerne notre périmètre */DATA tempo.Bd_axiva_&mm&aa;SET tempo.Bd_axiva_&mm&aa;if Raison_Sociale_autre_code_port='AXIVA' then output ;RUN;DATA tempo.Bd_axiva_&mm&aa;SET tempo.Bd_axiva_&mm&aa;Code_apporteur2=input(Code_apporteur,16.);DROP Code_apporteur;RENAME Code_apporteur2=Code_apporteur;RUN;proc sort data=tempo.Bd_axiva_&mm&aa nodupkey;by code_apporteur;run;%rangement1(tempo.PAM_AMADEO&mm&aa,Code_apporteur);%rangement1(tempo.Bd_axiva_&mm&aa,Code_apporteur);Data tempo.PAM_AMADEO_axiva;Merge tempo.Bd_axiva_&mm&aa (in=a) tempo.PAM_AMADEO&mm&aa (in=b) ;By Code_apporteur;If b ;Run;%M_Zero(tempo.PAM_AMADEO_axiva,tempo.PAM_AMADEO_axiva);DATA tempo.CA_PM_PAM_AMADEO_1;SET tempo.PAM_AMADEO_axiva;reg = Libelle_region;keep Code_courtier Raison_sociale_courtier  Code_cabinet Raison_sociale_cabinet Libel_produitNUMERO_CONTRAT DATE_EFFET_CONTRAT Date_terme Etat_Contrat CODE_ISIN NOM_SUPPORT VI VC PM Rachat Reseau Arbitrage_Entree Arbitrage_Sortie Nom_Prenom_Client age CP_Client reg TYPE_GARANTIE_DECES Frais_VI Frais_VC TAUX_ANNUEL_FRAIS_SUR_ENCOURS MANDAT_DE_GESTION Code_apporteur;run;DATA tempo.CA_PM_PAM_AMADEO_1;SET tempo.PAM_AMADEO_axiva;Rename Code_apporteur=Code_ptf;Label Code_apporteur=Code_ptf;Run;%rangement1(tempo.CA_PM_PAM_AMADEO_1,code_cabinet);/* Une ligne par code_cabinet */proc sql;create table tempo.BD_sans_doub (code_cabinet num,libelle_region char(30),Prenom_Inspecteur char(30),Nom_Inspecteur char(30));insert into tempo.BD_sans_doubselect  distinct code_cabinet, libelle_region, Prenom_Inspecteur, Nom_Inspecteurfrom tempo.BD&mm&aa;quit;DATA tempo.CA_PM_PAM_AMADEO_1;SET tempo.CA_PM_PAM_AMADEO_1;Code_cabinet2=input(Code_cabinet,8.);DROP Code_cabinet;RENAME Code_cabinet2=Code_cabinet;RUN; %rangement1(tempo.CA_PM_PAM_AMADEO_1,Code_cabinet);%rangement1(tempo.BD_sans_doub,Code_cabinet);data tempo.CA_PM_PAM_AMADEO_2;length Libelle_region $20;merge tempo.CA_PM_PAM_AMADEO_1 (in = a) tempo.BD_sans_doub (in = b);by code_cabinet;if a;run;%M_zero(tempo.CA_PM_PAM_AMADEO_2,tempo.CA_PM_PAM_AMADEO_2);/* Récupérer les région */data tempo.CA_PM_PAM_AMADEO_2;length reg $35;set tempo.CA_PM_PAM_AMADEO_2;If NUMERO_CONTRAT="883/1789" THEN reg="Nord-Est";if reg = "" then reg=Libelle_region;drop Libelle_region;run;data tempo.CA_PM_PAM_AMADEO_2;length reg $35;set tempo.CA_PM_PAM_AMADEO_2;rename reg = Libelle_region;run;/*------------ CHANGEMENT DE CLE DE JOINTURE ----------*//*----------------------------------------------------------*//* Concaténation la table "essai_4" avec les tables : Anciens et Nouveaux Protocoles   avant de la séparer en deux tables : PAM et AMADEO */%rangement1(tempo.CA_PM_PAM_AMADEO_2,Code_cabinet);data tempo.CA_PM_PAM_AMADEO_2 ; set tempo.CA_PM_PAM_AMADEO_2 ; drop  Code_cabinet ; run ; proc sort data= tempo.CA_PM_PAM_AMADEO_2 ; by code_courtier ; run;  proc sort data= tempo.nouveau_proto ; by code_courtier ; run;proc sort data= tempo.ancien_proto ; by code_courtier ; run;%concat_condition3(tempo.CA_PM_PAM_AMADEO_2 ,tempo.nouveau_proto,tempo.ancien_proto,tempo.concat_proto, Code_courtier /*Code_cabinet*/);%M_zero(tempo.concat_proto,tempo.concat_proto);/*proc sort data= tempo.CA_PM_PAM_AMADEO_2 ; by Code_cabinet ; run;  */proc sort data= tempo.nouveau_proto ; by Code_cabinet ; run;proc sort data= tempo.ancien_proto ; by Code_cabinet ; run;/*----------------------------------------------------------*/data tempo.concat_proto_V1;set tempo.concat_proto;length Avenant $30;IF Sans_Avenant=1 THEN Avenant="Nvelle convention sans Avenant";IF Avenant_Vie_75_ke=1 THEN Avenant="Avenant Vie 75ke";IF Avenant_Vie_150_ke=1 THEN Avenant="Avenant Vie 150ke";IF Avenant_Vie_300_ke=1 THEN Avenant="Avenant Vie 300ke";IF Avenant_Vie_600_ke=1 THEN Avenant="Avenant Vie 600ke";IF Avenant_Vie_1000_ke=1 THEN Avenant="Avenant Vie 1000ke";IF Avenant_Vie_4_Me=1 THEN Avenant="Avenant Vie 4Me";IF Avenant_Vie_6_Me=1 THEN Avenant="Avenant Vie 6Me";IF Triaction_1_5_M=1 THEN Avenant="Triaction 1,5Me";IF Triaction_2_5_M=1 THEN Avenant="Triaction 2,5Me";keep Code_courtier Raison_sociale_courtier  Code_cabinet Raison_sociale_cabinet Libel_produitNUMERO_CONTRAT DATE_EFFET_CONTRAT Date_terme Etat_Contrat CODE_ISIN NOM_SUPPORT VI VC PM Rachat Reseau Arbitrage_Entree Arbitrage_Sortie Nom_Prenom_Client age CP_Client Libelle_region TYPE_GARANTIE_DECESANNE_PROTOCOLE Avenant Libelle_Du_Protocole Frais_VI Frais_VC /*-->*/Ann_e_saisie_ancien_protoPrenom_Inspecteur Nom_Inspecteur TAUX_ANNUEL_FRAIS_SUR_ENCOURS MANDAT_DE_GESTION Code_ptf;run;data tempo.concat_proto_V1;set tempo.concat_proto_V1;if ANNE_PROTOCOLE=0 and Ann_e_saisie_ancien_proto^=0 then Annee_proto = Ann_e_saisie_ancien_proto;if ANNE_PROTOCOLE^=0 then Annee_proto = ANNE_PROTOCOLE;if ANNE_PROTOCOLE=0 and Ann_e_saisie_ancien_proto=0 then Annee_proto =0;run;data tempo.concat_proto_V1;set tempo.concat_proto_V1;if Avenant = "" and Libelle_Du_Protocole ^="" then Avenant = Libelle_Du_Protocole;if Avenant ^= "" then Avenant = Avenant;drop ANNE_PROTOCOLE Ann_e_saisie_ancien_proto;run;data tempo.PA_AM;set tempo.concat_proto_V1;if NOM_SUPPORT = "" then delete;if Avenant = "" then Avenant="NR";drop Libel_produit Libelle_Du_Protocole;run;data tempo.test_pers_morale;set tempo.PA_AM;test=scan(REVERSE(Nom_Prenom_Client),1," ");firts=first(test);run;data tempo.test_pers_morale;set tempo.test_pers_morale;if firts not in ("a" "b" "c" "d" "e" "f" "g" "h" "i" "j""k" "l" "m" "n" "o" "p" "q" "r" "s" "t" "u" "v" "w" "x" "y" "z" "?" /*""*/) then /*Pers_Phy_Mo="Personne Morale";*/ com=1;else /*Pers_Phy_Mo="Personne Physique";*/ com=0;run;data tempo.test_pers_morale;set tempo.test_pers_morale;if substr(Numero_contrat,1,3) in ("883") and com=1 then pb=1;else pb=0;run;data tempo.test_pers_morale;set tempo.test_pers_morale;length Pers_Phy_Mo$18;if com=1 then Pers_Phy_Mo="Personne Morale";else if com=0 then Pers_Phy_Mo="Personne Physique";run;data tempo.test_pers_morale;set tempo.test_pers_morale;length PP_PM $18;if substr(Numero_contrat,1,3) in ("883" "690") then PP_PM="Personne Physique";else PP_PM=Pers_Phy_Mo;run;data tempo.test_pers_morale;set tempo.test_pers_morale;length Nom_Produit $30;if substr(Numero_contrat,1,3) in ("691") Then Nom_Produit="Amadeo";if substr(Numero_contrat,1,3) in ("690") Then Nom_Produit="Amadeo";if substr(Numero_contrat,1,3) in ("883") Then Nom_Produit="PAM";if substr(Numero_contrat,1,4) in ("1013") Then Nom_Produit="PAM";run;data tempo.PA_AM_ok;set tempo.test_pers_morale;drop firts com pb Pers_Phy_Mo test;run;data tempo.PA_AM_ok;set tempo.PA_AM_ok;if Raison_sociale_courtier="" then Raison_sociale_courtier="NR";else Raison_sociale_courtier=Raison_sociale_courtier;if Raison_sociale_cabinet="" then Raison_sociale_cabinet="NR";else Raison_sociale_cabinet=Raison_sociale_cabinet;run;data tempo.PA_AM_ok;set tempo.PA_AM_ok;VLP="Pas de VLP pour ce produit";Frais_VLP="aucun car pas de VLP";run;/********* Table pour détail ***********/proc sql;create table tempo.PAM_AMADEO_Export_init asselect Code_courtier,Raison_sociale_courtier,Code_cabinet,Raison_sociale_cabinet,Libelle_region, Nom_Produit, NUMERO_CONTRAT, DATE_EFFET_CONTRAT, Date_terme, Etat_Contrat,CODE_ISIN ,NOM_SUPPORT,VI, VC, VLP, PM, Rachat, Arbitrage_Entree, Arbitrage_Sortie, Reseau,PP_PM,Nom_Prenom_Client, age, CP_Client, Avenant, Annee_proto,TYPE_GARANTIE_DECES ,Frais_VI,Frais_VC,Frais_VLP,Prenom_Inspecteur, Nom_Inspecteur, TAUX_ANNUEL_FRAIS_SUR_ENCOURS, MANDAT_DE_GESTION, Code_ptf, NOM_SUPPORTfrom tempo.PA_AM_ok;quit;DATA tempo.PAM_AMADEO_Export_init;length Libelle_region $20;SET tempo.PAM_AMADEO_Export_init;RUN;%rangement1(tempo.PAM_AMADEO_Export_init,numero_contrat);/*******************************************/DATA tempo.PA_AM_tt_supp;SET tempo.PAM_AMADEO_Export_init;IF code_isin in ('' ' ' '.') THEN support ="AUTRE";ELSE IF substr(code_isin,1,2) in ('F0','F1','F2','F3','F4','F5','F6','F7','F8','F9') THENsupport = "EURO";ELSE support = "UC";if pm<0 then pm=0;RUN;PROC SORT DATA=tempo.PA_AM_tt_supp;BY Code_courtier Raison_sociale_courtier Code_cabinet Raison_sociale_cabinet Libelle_regionNom_Produit NUMERO_CONTRAT DATE_EFFET_CONTRAT Date_terme Etat_Contrat NOM_SUPPORT PP_PM Nom_Prenom_Clientage CP_Client Avenant Annee_proto TYPE_GARANTIE_DECES Code_ptf Reseau Prenom_Inspecteur Nom_Inspecteur TAUX_ANNUEL_FRAIS_SUR_ENCOURS MANDAT_DE_GESTION ;run; DATA tempo.PAM_AMADEO_Export2;SET tempo.PA_AM_tt_supp;RUN;proc sort data= tempo.PAM_AMADEO_Export2 out = tempo.PAM_AMADEO_Export2bis nodupkey;by NUMERO_CONTRAT NOM_SUPPORT;run;PROC SORT DATA=tempo.PA_AM_tt_supp;BY NUMERO_CONTRAT;run;PROC SUMMARY DATA=tempo.PA_AM_tt_supp;VAR VI VC PM Frais_VI Frais_VC ;BY NUMERO_CONTRAT;WHERE support="UC";OUTPUT OUT=tempo.PA_AM_UC (drop=_type_ _freq_) SUM=;RUN;PROC SUMMARY DATA=tempo.PA_AM_tt_supp;VAR VI VC PM Frais_VI Frais_VC Rachat Arbitrage_Entree Arbitrage_Sortie ;BY NUMERO_CONTRAT;id Code_courtier Raison_sociale_courtier  Code_cabinet Raison_sociale_cabinet Libelle_region Nom_Produit DATE_EFFET_CONTRAT Date_terme Etat_ContratPP_PM Nom_Prenom_Client age CP_Client Avenant Annee_proto TYPE_GARANTIE_DECES Code_ptf ReseauPrenom_Inspecteur Nom_Inspecteur TAUX_ANNUEL_FRAIS_SUR_ENCOURS MANDAT_DE_GESTION;OUTPUT OUT=tempo.PA_AM_tot (drop=_type_ _freq_) SUM=;RUN;DATA tempo.PA_AM_UC;SET tempo.PA_AM_UC;VI_UC=VI;VC_UC=VC;PM_UC=PM;DROP VI VC PM;RUN;DATA tempo.PA_AM_tot_UC;MERGE tempo.PA_AM_tot tempo.PA_AM_UC;BY NUMERO_CONTRAT;RUN;%M_zero(tempo.PA_AM_tot_UC,tempo.PA_AM_tot_UC);data tempo.PA_AM_tot_UC;set tempo.PA_AM_tot_UC;CA=VI+VC;CA_UC=VI_UC+VC_UC;if (CA_UC)^=0 then part_CA_UC=(CA_UC)/(CA);else part_CA_UC=0;if PM ^=0 then part_PM_UC=PM_UC/PM;else part_PM_UC=0;run;data tempo.PA_AM_tot_UC;set tempo.PA_AM_tot_UC;if part_PM_UC >= (25/100) then condition_UC_PM_encours=1;else condition_UC_PM_encours=0;if PM >= 50000 then condition_PM_tot_encours=1;else condition_PM_tot_encours=0;run;data tempo.PA_AM_tot_UC;set tempo.PA_AM_tot_UC;length tranche_part_PM_UC $20;length tranche_CA $60;length tranche_PM $60;If CA >= 100000 Then tranche_CA="100ke et plus";else If CA>0 and CA < 500 Then tranche_CA="0-0.5ke";else if CA=0 then tranche_CA="Pas de prod";else if CA<0 then tranche_CA="Vérif Etat du contrat ou Annulation du versement";else If CA >= 500 and CA < 1000 Then tranche_CA="0.5-1ke";else If CA >= 1000 and CA < 3000 Then tranche_CA="1-3ke";else If CA >= 3000 and CA < 20000 Then tranche_CA="3-20ke";else If CA >= 20000 and CA < 50000 Then tranche_CA="20-50ke";else If CA >= 50000 and CA < 100000 Then tranche_CA="50ke-100ke";if part_PM_UC<(10/100) then tranche_part_PM_UC="<10%";else if (part_PM_UC>=(10/100) and part_PM_UC<(25/100)) then tranche_part_PM_UC="[10%;25%[";else if part_PM_UC>=(25/100) then tranche_part_PM_UC=">=25%";If PM >= 100000 Then tranche_PM="100ke et plus";else If PM>0 and PM < 500 Then tranche_PM="0-0.5ke";else if PM=0 then tranche_PM="Pas de prod";else if PM<0 then tranche_PM="Vérif Etat du contrat ou Annulation du versement";else If PM >= 500 and PM < 1000 Then tranche_PM="0.5-1ke";else If PM >= 1000 and PM < 3000 Then tranche_PM="1-3ke";else If PM >= 3000 and PM < 20000 Then tranche_PM="3-20ke";else If PM >= 20000 and PM < 50000 Then tranche_PM="20-50ke";else If PM >= 50000 and PM < 100000 Then tranche_PM="50ke-100ke";run;/****** Table pour synthèse *******/data tempo.PA_AM_tot_UC;set tempo.PA_AM_tot_UC;Frais_VLP=999999999;Systeme="Axiome   ";rename PP_PM=Civilite;run;PROC SORT DATA=tempo.PA_AM_tot_UC;BY Code_courtier Raison_sociale_courtier  Code_cabinet  Raison_sociale_cabinet ;run;proc sort data= tempo.PA_AM_tot_UC out = tempo.PA_AM_tot_UC_bis nodupkey;by NUMERO_CONTRAT PM;run;/*------------------------*//*      FIN AXIOME V1     *//*------------------------*/ /*--------------------*//*        NACT        *//*--------------------*//* Récupération des variables nécessaires */DATA tempo.nact&mm&aa;SET NACT.NACT&aa&mm;KEEP numctv codport libprod codprod region reseau DTEFF CODETA CODUC DATECH DATNAIS CODQSOU NOMABR ARB_ENT ARB_SOR AN_BRUT AN_FVAR RE_BRUT SE_BRUT VL_BRUT PA_BRUT QT_BRUT QH_BRUTrp_cap rg_cap rt_cap resil extinc ec_cap si_cap PMZIL CODSUP LIBSUPP an_inv vl_inv PA_netco QT_netco QH_netco RE_net SE_net ;RUN;/* Mise à zéro des cellules numériques vides */%M_zero(tempo.nact&mm&aa,tempo.nact&mm&aa);/* Table Selo avant de regrouper avec la table BD */DATA tempo.selo_VO&mm&aa;SET tempo.nact&mm&aa;Code_ptf=codport * 1;date=put(DATNAIS,8.);VI=AN_BRUT;VC=VL_BRUT;VLP=PA_BRUT+QT_BRUT+QH_BRUT-RE_BRUT-SE_BRUT;Frais_VI=AN_FVAR;   /**  **/Frais_VC=VC-VL_inv;Frais_VLP=VLP-(PA_netco+QT_netco+QH_netco-RE_net-SE_net);Civilite=CODQSOU;Nom_Client=NOMABR;Rachat = rp_cap + rg_cap + rt_cap + resil + extinc + ec_cap + si_cap;PM=PMZIL;Rachat_Partiel=rp_cap;Rachat_Total=rt_cap;Arbitrage_Entree=ARB_ENT;Arbitrage_Sortie=ARB_SOR;date_effet = substr(DTEFF,7,2)||'/'||substr(DTEFF,5,2)||'/'||substr(DTEFF,1,4);DROP codport AN_BRUT AN_FVAR RE_BRUT SE_BRUT VL_BRUT PA_BRUT QT_BRUT QH_BRUT DTEFFrp_cap rg_cap rt_cap resil extinc ec_cap si_cap PMZIL ARB_ENT ARB_SOR AN_inv VL_inv PA_netco QT_netco QH_netco RE_net SE_net ;if reseau in ("COURTIERS","CGPI","PARTENAIRE DIST","PARTENAIRE BANK") THEN OUTPUT; /* reseau nova salaries aga agvs*/RUN;/* Mise à zéro des cellules numériques vides */%M_zero(tempo.selo_VO&mm&aa,tempo.selo_VO&mm&aa);data tempo.selo&mm&aa;set tempo.selo_VO&mm&aa;length Type_Rachat $20;length Etat $35;age=&aa_aa-substr(date,1,4);if substr(DATECH,11,2)^="" then date_ech = substr(DATECH,11,2)||'/'||substr(DATECH,9,2)||'/'||substr(DATECH,5,4);IF Codeta="EC" THEN Etat="Echu réglé ou constitutif de rente";else IF Codeta="ED" THEN Etat="Mise en demeure";else IF Codeta="EG" THEN Etat="Echu à gérer (traiter)";else IF Codeta="EP" THEN Etat="Echu à payer (régler)";else IF Codeta="RE" Or Codeta="RN" THEN Etat="Renonciation";else IF Codeta="EV" THEN Etat="En vigueur";else IF Codeta="ET" THEN Etat="Eteint";else IF Codeta="EX" THEN Etat="Expiré";else IF Codeta="RE" THEN Etat="Réduit";else IF Codeta="RT" THEN Etat="Racheté";else IF Codeta="SE" THEN Etat="Sans effet";else IF Codeta="SI" THEN Etat="Sinistré";else IF Codeta="SU" THEN Etat="Suspendu";else IF Codeta="XX" THEN Etat="XX";else IF Codeta="LC" THEN Etat="Libéré de cotisations";else IF Codeta="EC" THEN Etat="Echu réglé ou constitutif de rente";else IF Codeta="MG" THEN Etat="Résilié avec maintien des garanties";else IF Codeta="RD" THEN Etat="Réduit";else IF Codeta="TR" THEN Etat="Remplacé ou Transformé";else Etat="XX"; /* modif pour traiter les XX */if Rachat_Total<=0 and Rachat_Partiel>0 then Type_Rachat="";else if Rachat_Total>0 then Type_Rachat="Rachat Total";drop Codeta;run;/*Correction Etat différent pour un même contrat*/proc sort data= tempo.selo&mm&aa;by NUMCTV Etat;run; data tempo.seloV0a;set tempo.selo&mm&aa;drop Etat;run;data tempo.seloV0b;set tempo.selo&mm&aa;by NUMCTV Etat;if first.NUMCTV then output;keep NUMCTV Etat;run;proc sql ;create table tempo.seloV0 asselect * from tempo.seloV0a B1, tempo.seloV0b B2where (B1.NUMCTV=B2.NUMCTV) ;quit;/* Table Selo avec code courtier */%rangement1(tempo.seloV0,Code_ptf);%rangement1(tempo.Bd&mm&aa,Code_ptf);DATA tempo.CA_selo;MERGE tempo.Bd&mm&aa (in=a) tempo.seloV0 (in=b);BY Code_ptf;if b;RUN;%M_zero(tempo.CA_selo,tempo.CA_selo);/* Suppression code_courtier=99999 *//* Définir les régions par leurs codes */DATA tempo.CA_selo;SET tempo.CA_selo;length region_correspondante $30;If code_region="64" Then region_correspondante="Ile-de-France";If code_region="65" Then region_correspondante="Nord-Est";If code_region="66" Then region_correspondante="Ouest";If code_region="67" Then region_correspondante="Sud-Est";If code_region="68" Then region_correspondante="Sud-Ouest";RUN;/* Table Selo avec les variables souhaitées pour la REC */data tempo.Selo_V0;set tempo.CA_selo;keep Code_courtier Raison_sociale_courtier Code_cabinet Raison_sociale_cabinet codprod LIBPROD NUMCTV date_effet date_ech CODSUP CODUC LIBSUPP VI VC VLP PM Rachat Type_Rachat Arbitrage_Entree Arbitrage_Sortie Civilite Nom_Client region_correspondantereseau Type_Inspecteur Etat age Frais_VI Frais_VC Frais_VLP Code_ptf Prenom_Inspecteur Nom_Inspecteur;rename region_correspondante = Region  ;run;proc sort data = tempo.Selo_V0;by Code_courtier Raison_sociale_courtier Code_cabinet Raison_sociale_cabinetcodprod LIBPROD NUMCTV date_effet date_ech CODSUP CODUC LIBSUPP Type_RachatCivilite Nom_Client Region reseau Type_Inspecteur Etat Code_ptf Prenom_Inspecteur Nom_Inspecteur;run;proc summary data = tempo.Selo_V0;var VI VC VLP PM Rachat Arbitrage_Entree Arbitrage_Sortie Frais_VI Frais_VC Frais_VLP;by Code_courtier Raison_sociale_courtier Code_cabinet  Raison_sociale_cabinetcodprod LIBPROD NUMCTV date_effet date_ech CODSUP CODUC LIBSUPP Type_RachatCivilite Nom_Client Region reseau Type_Inspecteur Etat age Code_ptf Prenom_Inspecteur Nom_Inspecteur;OUTPUT OUT=tempo.Selo_V1 (drop=_type_ _freq_)SUM=;RUN;/* Concaténation de la table "Selo_V1" avec les tables : Anciens et Nouveaux Protocoles */%rangement1(tempo.Selo_V1,Code_cabinet);%concat_condition3(tempo.Selo_V1,tempo.nouveau_proto,tempo.ancien_proto,tempo.concat_proto_selo,Code_cabinet);%M_zero(tempo.concat_proto_selo,tempo.concat_proto_selo);data tempo.concat_proto_selo;         set tempo.concat_proto_selo;           length Avenant $30;IF Sans_Avenant=1 THEN Avenant="Nvelle convention sans Avenant";IF Avenant_Vie_75_ke=1 THEN Avenant="Avenant Vie 75ke";IF Avenant_Vie_150_ke=1 THEN Avenant="Avenant Vie 150ke";IF Avenant_Vie_300_ke=1 THEN Avenant="Avenant Vie 300ke";IF Avenant_Vie_600_ke=1 THEN Avenant="Avenant Vie 600ke";IF Avenant_Vie_1000_ke=1 THEN Avenant="Avenant Vie 1000ke";IF Avenant_Vie_4_Me=1 THEN Avenant="Avenant Vie 4Me";IF Avenant_Vie_6_Me=1 THEN Avenant="Avenant Vie 6Me";IF Triaction_1_5_M=1 THEN Avenant="Avenant Vie 1,5Me";IF Triaction_2_5_M=1 THEN Avenant="Avenant Vie 2,5Me";keep Code_courtier Raison_sociale_courtier Code_cabinet Raison_sociale_cabinetcodprod LIBPROD NUMCTV date_effet date_ech CODSUP CODUC LIBSUPP VI VC VLP PM Rachat Type_RachatArbitrage_Entree Arbitrage_Sortie Civilite Nom_Client Region reseau Type_Inspecteur EtatANNE_PROTOCOLE Avenant Libelle_Du_Protocole Ann_e_saisie_ancien_proto age Frais_VI Frais_VC Frais_VLP Code_ptf Prenom_Inspecteur Nom_Inspecteur;run;data tempo.concat_proto_selo;set tempo.concat_proto_selo;if ANNE_PROTOCOLE=0 and Ann_e_saisie_ancien_proto^=0 then Annee_proto = Ann_e_saisie_ancien_proto;if ANNE_PROTOCOLE^=0 then Annee_proto = ANNE_PROTOCOLE;if ANNE_PROTOCOLE=0 and Ann_e_saisie_ancien_proto=0 then Annee_proto =0;run;data tempo.concat_proto_selo;set tempo.concat_proto_selo;if Avenant = "" and Libelle_Du_Protocole ^="" then Avenant = Libelle_Du_Protocole;if Avenant ^= "" then Avenant = Avenant;drop ANNE_PROTOCOLE Ann_e_saisie_ancien_proto Libelle_Du_Protocole;run;%rangement1(tempo.concat_proto_selo,CODSUP);DATA tempo.concat_proto_selob;MERGE tempo.concat_proto_selo (in=b) tempo.Table_isin (in=a);BY CODSUP;if b;RUN;data tempo.concat_proto_selo2;set tempo.concat_proto_selob;if Avenant = "" then Avenant="NR";where (code_courtier^=99999 and substr(LIBPROD,1,6)^="MASTER" and substr(LIBPROD,1,7)^="TONTINE" and substr(LIBPROD,1,10)^="TEMPORAIRE" and substr(LIBPROD,1,7)^="NEWPREV" and substr(LIBPROD,1,6)^="COFAST" and substr(LIBPROD,1,5)^="MIXTE" and substr(LIBPROD,1,7)^="PROTECT" and substr(LIBPROD,1,4)^="UNIP" and substr(LIBPROD,1,7)^="UNIPREV" and substr(LIBPROD,1,11)^="VIE ENTIERE");rename NUMCTV=NUMERO_CONTRAT    LIBPROD=Nom_Produit    Etat=Etat_Contrat    Region=Libelle_region    LIBSUPP=NOM_SUPPORT    ISIN=CODE_ISIN;drop TYPE;run;data tempo.concat_proto_selo;set tempo.concat_proto_selo2;keep Code_courtier Raison_sociale_courtier Code_cabinet Raison_sociale_cabinet Libelle_region Nom_Produit NUMERO_CONTRAT date_effet date_ech CODE_ISIN Etat_Contrat  VI VC VLP PM Rachat  Arbitrage_Entree Arbitrage_Sortie NOM_SUPPORT CODSUPCivilite Nom_Client  age Avenant Annee_proto Type_Rachat reseau Type_Inspecteur codprod Frais_VI Frais_VC Frais_VLP Code_ptf Prenom_Inspecteur Nom_Inspecteur;run;/********* Tables pour détail *******/%rangement1(tempo.concat_proto_selo,codprod);%rangement1(tempo.ilis_asso_bis,codprod);%concat_condition2(tempo.concat_proto_selo,tempo.ilis_asso_bis,tempo.concat_proto_selo_asso,codprod,a);data tempo.SELO_Export_asso;set tempo.concat_proto_selo_asso;where substr(codprod,1,5) in ("86284");drop CODPROD;run;PROC SORT DATA= tempo.SELO_Export_asso;BY Code_courtier Raison_sociale_courtier Code_cabinet Raison_sociale_cabinet Libelle_region Nom_Produit NUMERO_CONTRAT date_effet date_ech CODE_ISIN Etat_Contrat NOM_SUPPORT Civilite Nom_Client age Avenant Annee_proto Type_Rachat reseau  Type_Inspecteur  Code_ptf Prenom_Inspecteur Nom_Inspecteur ;RUN;PROC SUMMARY DATA=tempo.SELO_Export_asso;VAR VI VC VLP PM Frais_VI Frais_VC Frais_VLP ;BY Code_courtier Raison_sociale_courtier Code_cabinet Raison_sociale_cabinet Libelle_region Nom_Produit NUMERO_CONTRAT date_effet date_ech CODE_ISIN Etat_Contrat NOM_SUPPORTCivilite Nom_Client age Avenant Annee_proto Type_Rachat reseau Type_Inspecteur Code_ptf Prenom_Inspecteur Nom_Inspecteur ;OUTPUT OUT=tempo.SELO_Export_asso2 (drop=_type_ _freq_) SUM=;RUN;data tempo.PERP_Export_asso;set tempo.concat_proto_selo_asso;where substr(codprod,1,5) in ("91694");drop CODPROD;run;PROC SORT DATA= tempo.PERP_Export_asso;BY Code_courtier Raison_sociale_courtier Code_cabinet Raison_sociale_cabinet Libelle_region Nom_Produit NUMERO_CONTRAT date_effet date_ech CODE_ISIN Etat_Contrat NOM_SUPPORT Civilite Nom_Client age Avenant Annee_proto Type_Rachat reseau  Type_Inspecteur  Code_ptf Prenom_Inspecteur Nom_Inspecteur ;RUN;PROC SUMMARY DATA=tempo.PERP_Export_asso;VAR VI VC VLP PM Frais_VI Frais_VC Frais_VLP ;BY Code_courtier Raison_sociale_courtier Code_cabinet Raison_sociale_cabinet Libelle_region Nom_Produit NUMERO_CONTRAT date_effet date_ech CODE_ISIN Etat_Contrat NOM_SUPPORTCivilite Nom_Client age Avenant Annee_proto Type_Rachat reseau Type_Inspecteur Code_ptf Prenom_Inspecteur Nom_Inspecteur ;OUTPUT OUT=tempo.PERP_Export_asso2 (drop=_type_ _freq_) SUM=;RUN;data tempo.Autres_Export_asso;set tempo.concat_proto_selo_asso;where substr(codprod,1,5) not in ("86284" "91694"); /* AJOUTER  LES CODES ARPEGES ET CISELIUM */drop CODPROD;run;PROC SORT DATA= tempo.Autres_Export_asso;BY Code_courtier Raison_sociale_courtier Code_cabinet Raison_sociale_cabinet Libelle_region Nom_Produit NUMERO_CONTRAT date_effet date_ech CODE_ISIN Etat_Contrat NOM_SUPPORT Civilite Nom_Client age Avenant Annee_proto Type_Rachat reseau  Type_Inspecteur Code_ptf Prenom_Inspecteur Nom_Inspecteur ;RUN;PROC SUMMARY DATA=tempo.Autres_Export_asso;VAR VI VC VLP PM Frais_VI Frais_VC Frais_VLP ;BY Code_courtier Raison_sociale_courtier Code_cabinet Raison_sociale_cabinet Libelle_region Nom_Produit NUMERO_CONTRAT date_effet date_ech CODE_ISIN Etat_Contrat NOM_SUPPORTCivilite Nom_Client age Avenant Annee_proto Type_Rachat reseau Type_Inspecteur Code_ptf Prenom_Inspecteur Nom_Inspecteur ;OUTPUT OUT= tempo.Autres_Export_asso2 (drop=_type_ _freq_) SUM=;RUN;/**********************************/Data tempo.Synt_NACT;set tempo.concat_proto_selo_asso;length support $20;IF codsup in ("81074","87154","87164","87174","87184","87194","87204","87214","88204","89174","87384","87194","90664","89804")THEN support ="EURO";ELSE support = "UC";run;PROC SORT DATA=tempo.Synt_NACT;BY Code_courtier Raison_sociale_courtier Code_cabinet Raison_sociale_cabinet Libelle_region Nom_Produit NUMERO_CONTRAT date_effet date_ech Etat_ContratCivilite Nom_Client age Avenant Annee_proto Type_Rachat reseau  Type_Inspecteur  support Code_ptf Prenom_Inspecteur Nom_Inspecteur ;RUN;PROC SUMMARY DATA=tempo.Synt_NACT;VAR VI VC VLP PM Frais_VI Frais_VC Frais_VLP ;BY Code_courtier Raison_sociale_courtier Code_cabinet Raison_sociale_cabinet Libelle_region Nom_Produit NUMERO_CONTRAT date_effet date_ech Etat_ContratCivilite Nom_Client age Avenant Annee_proto Type_Rachat reseau Type_Inspecteur Code_ptf Prenom_Inspecteur Nom_Inspecteur ;WHERE support="UC" ;OUTPUT OUT=tempo.Synt_NACT_UC (drop=_type_ _freq_) SUM=;RUN;PROC SORT DATA=tempo.Synt_NACT;BY Code_courtier Raison_sociale_courtier Code_cabinet Raison_sociale_cabinet Libelle_region Nom_Produit NUMERO_CONTRAT date_effet date_ech Etat_ContratCivilite Nom_Client age Avenant Annee_proto Type_Rachat reseau  Type_Inspecteur Code_ptf Prenom_Inspecteur Nom_Inspecteur;RUN;PROC SUMMARY DATA=tempo.Synt_NACT;VAR VI VC VLP PM Rachat Arbitrage_Entree Arbitrage_Sortie Frais_VI Frais_VC Frais_VLP;BY Code_courtier Raison_sociale_courtier Code_cabinet Raison_sociale_cabinet Libelle_region Nom_Produit NUMERO_CONTRAT date_effet date_ech Etat_ContratCivilite Nom_Client age Avenant Annee_proto Type_Rachat reseau  Type_Inspecteur Code_ptf Prenom_Inspecteur Nom_Inspecteur;OUTPUT OUT=tempo.Synt_NACT_tot (drop=_type_ _freq_) SUM=;RUN;DATA tempo.Synt_NACT_UC;SET tempo.Synt_NACT_UC;VI_UC=VI;VC_UC=VC;VLP_UC=VLP;PM_UC=PM;drop VI VC VLP PM;RUN;PROC sort DATA=tempo.Synt_NACT_UC;BY Code_courtier Raison_sociale_courtier Code_cabinet Raison_sociale_cabinet Libelle_region Nom_Produit NUMERO_CONTRAT date_effet date_ech Etat_Contrat Civilite Nom_Client age Avenant Annee_proto Type_Rachat reseau Type_Inspecteur Code_ptf Prenom_Inspecteur Nom_Inspecteur;RUN;PROC sort DATA=tempo.Synt_NACT_tot;BY Code_courtier Raison_sociale_courtier Code_cabinet Raison_sociale_cabinet Libelle_region Nom_Produit NUMERO_CONTRAT date_effet date_ech Etat_Contrat Civilite Nom_Client age Avenant Annee_proto Type_Rachat reseau  Type_Inspecteur Code_ptf Prenom_Inspecteur Nom_Inspecteur ;RUN;DATA tempo.Synt_NACT_tot_UC;MERGE tempo.Synt_NACT_tot tempo.Synt_NACT_UC;BY Code_courtier Raison_sociale_courtier Code_cabinet Raison_sociale_cabinet Libelle_region Nom_Produit NUMERO_CONTRAT date_effet date_ech Etat_Contrat Civilite Nom_Client age Avenant Annee_proto Type_Rachat reseau  Type_Inspecteur Code_ptf Prenom_Inspecteur Nom_Inspecteur ;RUN;%M_zero(tempo.Synt_NACT_tot_UC,tempo.Synt_NACT_tot_UC);data tempo.Synt_NACT_tot_UC;set tempo.Synt_NACT_tot_UC;CA=VI+VC+VLP;CA_UC=VI_UC+VC_UC+VLP_UC;if (VI+VC+VLP)^=0 then part_CA_UC=(VI_UC+VC_UC+VLP_UC)/(VI+VC+VLP);else part_CA_UC=0;if PM ^=0 then part_PM_UC=PM_UC/PM;else part_PM_UC=0;run;data  tempo.Synt_NACT_tot_UC;set  tempo.Synt_NACT_tot_UC;if part_PM_UC >= (25/100) then condition_UC_PM_encours=1;else condition_UC_PM_encours=0;if PM >= 50000 then condition_PM_tot_encours=1;else condition_PM_tot_encours=0;run;data  tempo.Synt_NACT_tot_UC;set  tempo.Synt_NACT_tot_UC;length tranche_part_PM_UC $20;length tranche_CA $60;length tranche_PM $60;If CA >= 100000 Then tranche_CA="100ke et plus";else If CA>0 and CA < 500 Then tranche_CA="0-0.5ke";else if CA=0 then tranche_CA="Pas de prod";else if CA<0 then tranche_CA="Vérif Etat du contrat ou Annulation du versement";else If CA >= 500 and CA < 1000 Then tranche_CA="0.5-1ke";else If CA >= 1000 and CA < 3000 Then tranche_CA="1-3ke";else If CA >= 3000 and CA < 20000 Then tranche_CA="3-20ke";else If CA >= 20000 and CA < 50000 Then tranche_CA="20-50ke";else If CA >= 50000 and CA < 100000 Then tranche_CA="50ke-100ke";if part_PM_UC<(10/100) then tranche_part_PM_UC="<10%";else if (part_PM_UC>=(10/100) and part_PM_UC<(25/100)) then tranche_part_PM_UC="[10%;25%[";else if part_PM_UC>=(25/100) then tranche_part_PM_UC=">=25%";If PM >= 100000 Then tranche_PM="100ke et plus";else If PM>0 and PM < 500 Then tranche_PM="0-0.5ke";else if PM=0 then tranche_PM="Pas de prod";else if PM<0 then tranche_PM="Vérif Etat du contrat ou Annulation du versement";else If PM >= 500 and PM < 1000 Then tranche_PM="0.5-1ke";else If PM >= 1000 and PM < 3000 Then tranche_PM="1-3ke";else If PM >= 3000 and PM < 20000 Then tranche_PM="3-20ke";else If PM >= 20000 and PM < 50000 Then tranche_PM="20-50ke";else If PM >= 50000 and PM < 100000 Then tranche_PM="50ke-100ke";run;data tempo.Synt_NACT_tot_UC;set tempo.Synt_NACT_tot_UC;rename date_effet=DATE_EFFET_CONTRATdate_ech=Date_termeNom_client=Nom_Prenom_Client;run;data tempo.Synt_NACT_tot_UC;set tempo.Synt_NACT_tot_UC;Systeme="NOVA";run;/******* Table pour synthèse ********/PROC SORT DATA=tempo.Synt_NACT_tot_UC;BY Code_courtier Raison_sociale_courtier  Code_cabinet  Raison_sociale_cabinet ;run;/*----------------------------*//*           FIN NACT      *//*----------------------------*//*-------------------------*//*     AXIOME V4 : 93254  -- MIGRATION Ciselium VERS NOVA - 2015  *//*-------------------------*//* Récupération de la table stock_saxo avec seulement le produit concerné : Cisélium */DATA tempo.stock_saxo&mm&aa;SET  stock.saxostock;If substr(CODE_PRODUIT,1,5)in ("93254" "91804" "93004");run; %M_Zero(tempo.stock_saxo&mm&aa,tempo.stock_saxo&mm&aa);/**************** Eliminer les contrats sans effet *******************/DATA tempo.stock_saxo&mm&aa;SET  tempo.stock_saxo&mm&aa;If SITUATION_CLOTURE ^="sans effet";run; /* Recodage de la base DAV */data tempo.DAV&mm&aa;set tempo.stock_saxo&mm&aa;length Etat_Contrat $35;VI=PRIME_BRUTE_MONTANT;VC=VERSEMENTS_BRUTS_MONTANT;Frais_VC=VERSEMENTS_BRUTS_MONTANT-VERSEMENTS_INVESTIS_MONTANT;Frais_VI=PRIME_BRUTE_MONTANT - PRIME_INVESTIE_MONTANT;PM=VAL_ACQUISE_CLOT_MONTANT-MONTANT_NON_INVESTI_MONTANT;Retrait=RETRAITS_MONTANT;Etat_Contrat=SITUATION_CLOTURE;Nom_Prenom_Client=NOM_ET_PRENOM_DU_SOUSCRIPTEUR;CP_Client=CP_RESID_FISCALE_SOUSCRIPTEUR;Type_Gestion=MANDAT_DE_GESTION_COLLECTIF;Type_Gestion_Collective=MANDAT_DE_GESTION_PERSONNALISE;Type_Option=OPTION_FINANCIERE;Arbitrage_Entree=AE_MONTANT;Arbitrage_Sortie=AS_MONTANT;Code_ptf=substr(code_apporteur,2,9)*1;Reseau="Courtiers";if Etat_Contrat= "en cours" then Etat_Contrat= "En vigueur" ;if Etat_Contrat= "rachete" then Etat_Contrat= "Racheté";Keep NUMERO_CONTRAT DATE_EFFET_CONTRAT CODE_ISIN NOM_SUPPORT Etat_Contrat CODE_APPORTEUR RESEAU CODE_PRODUIT NOM_PRODUIT DATE_NAISSANCE_SOUSCRIPTEUR TYPE_GARANTIE_DECES VI VC PM Retrait Nom_Prenom_Client CP_Client Type_Gestion Type_Gestion_Collective Type_Option date_terme Arbitrage_Entree Arbitrage_Sortie Code_ptf Frais_VI Frais_VC reseau;run;/* Merger avec les tables BD */data tempo.Ciselium&mm&aa;set tempo.DAV&mm&aa;code2=CODE_APPORTEUR*1;age=&aa_aa-year(DATE_NAISSANCE_SOUSCRIPTEUR);Keep NUMERO_CONTRAT DATE_EFFET_CONTRAT CODE_ISIN NOM_SUPPORT Etat_Contrat CODE_APPORTEURRESEAU CODE_PRODUIT NOM_PRODUIT DATE_NAISSANCE_SOUSCRIPTEUR TYPE_GARANTIE_DECES VI VC PMRetrait Nom_Prenom_Client CP_Client Type_Gestion Type_Gestion_Collective Type_Option age date_terme Arbitrage_Entree Arbitrage_Sortie code2 Code_ptf Frais_VI Frais_VC reseau;run;%rangement1(tempo.Ciselium&mm&aa,Code2);%M_zero(tempo.Bd&mm&aa,tempo.Bd&mm&aa);proc sql ;create table tempo.Ciselium_V0 asselect * from tempo.Ciselium&mm&aa B1 LEFT JOIN tempo.Bd&mm&aa B2on (B1.Code2=B2.Code_ptf) ;quit;%M_zero(tempo.Ciselium_V0,tempo.Ciselium_V0&mm&aa);data tempo.Ciselium_V0;set tempo.Ciselium_V0;if code_apporteur =119347220 and NUMERO_CONTRAT="000008100220190" then code_courtier=558;if code_apporteur =119347220 and NUMERO_CONTRAT="000008100220190" then Raison_sociale_courtier="A A ASSURANCES";if code_apporteur =119347220 and NUMERO_CONTRAT="000008100220190" then Code_cabinet=7504;if code_apporteur =119347220 and NUMERO_CONTRAT="000008100220190" then Raison_sociale_cabinet="A A ASSURANCES";run;data tempo.Ciselium_V0;length Libelle_region $20;set tempo.Ciselium_V0;if Libelle_region="" and  Code_ptf = "111910220" then Libelle_region="Sud-Est";else if Libelle_region="" and Code_ptf = "119347220"  then Libelle_region="Ile-de-France";else if Libelle_region="" and Code_ptf = "201154684"  then Libelle_region="Nord-Est";else if Libelle_region^="" then Libelle_region=Libelle_region;run;/* CISELIUM finale */proc sort data = tempo.Ciselium_V0;by Code_courtier Raison_sociale_courtier Code_cabinet Raison_sociale_cabinet CODE_PRODUITNOM_PRODUIT NUMERO_CONTRAT DATE_EFFET_CONTRAT CODE_ISIN NOM_SUPPORT Etat_Contrat Type_GestionType_Gestion_Collective Type_Option NOM_PRODUIT PM VI VC FRAIS_VI FRAIS_VC TYPE_GARANTIE_DECES Nom_Prenom_Client CP_Client age Libelle_region date_terme Code_ptf reseau Prenom_Inspecteur Nom_Inspecteur;run;proc summary data = tempo.Ciselium_V0;var VI VC PM Retrait Arbitrage_Entree Arbitrage_Sortie Frais_VI Frais_VC;by Code_courtier Raison_sociale_courtier Code_cabinet Raison_sociale_cabinet CODE_PRODUIT NOM_PRODUIT NUMERO_CONTRAT DATE_EFFET_CONTRAT CODE_ISIN NOM_SUPPORT Etat_Contrat Type_Gestion Type_Gestion_Collective Type_Option NOM_PRODUIT PM VI VC FRAIS_VI FRAIS_VC TYPE_GARANTIE_DECES Nom_Prenom_Client CP_Client age Libelle_region date_terme Code_ptf reseau Prenom_Inspecteur Nom_Inspecteur;OUTPUT OUT=tempo.CISELIUM_V1 (drop=_type_ _freq_)SUM=;RUN;/* Concaténation de la table "CISELIUM_V1" avec les tables : Anciens et Nouveaux Protocoles */%rangement1(tempo.CISELIUM_V1,Code_Cabinet);%rangement1(tempo.ancien_proto,Code_Cabinet);%concat_condition3(tempo.CISELIUM_V1,tempo.nouveau_proto,tempo.ancien_proto,tempo.concat_proto_cis,Code_cabinet);%M_zero(tempo.concat_proto_cis,tempo.concat_proto_cis);data tempo.concat_proto_cis;         set tempo.concat_proto_cis;           length Avenant $30;IF Sans_Avenant=1 THEN Avenant="Nvelle convention sans Avenant";IF Avenant_Vie_75_ke=1 THEN Avenant="Avenant Vie 75ke";IF Avenant_Vie_150_ke=1 THEN Avenant="Avenant Vie 150ke";IF Avenant_Vie_300_ke=1 THEN Avenant="Avenant Vie 300ke";IF Avenant_Vie_600_ke=1 THEN Avenant="Avenant Vie 600ke";IF Avenant_Vie_1000_ke=1 THEN Avenant="Avenant Vie 1000ke";IF Avenant_Vie_4_Me=1 THEN Avenant="Avenant Vie 4Me";IF Avenant_Vie_6_Me=1 THEN Avenant="Avenant Vie 6Me";IF Triaction_1_5_M=1 THEN Avenant="Avenant Vie 1,5Me";IF Triaction_2_5_M=1 THEN Avenant="Avenant Vie 2,5Me";keep Code_courtier Raison_sociale_courtier Code_cabinet Raison_sociale_cabinet NUMERO_CONTRATDATE_EFFET_CONTRAT CODE_ISIN NOM_SUPPORT Etat_Contrat CODE_PRODUIT NOM_PRODUIT TYPE_GARANTIE_DECES VI VC PM Retrait Nom_Prenom_Client CP_Client Type_Gestion Type_Gestion_Collective Type_Option age Libelle_region date_terme Arbitrage_Entree Arbitrage_Sortie ANNE_PROTOCOLE Avenant Libelle_Du_Protocole Ann_e_saisie_ancien_protoCode_ptf Frais_VI Frais_VC reseau Prenom_Inspecteur Nom_Inspecteur;run;data tempo.concat_proto_cis;set tempo.concat_proto_cis;if ANNE_PROTOCOLE=0 and Ann_e_saisie_ancien_proto^=0 then Annee_proto = Ann_e_saisie_ancien_proto;if ANNE_PROTOCOLE^=0 then Annee_proto = ANNE_PROTOCOLE;if ANNE_PROTOCOLE=0 and Ann_e_saisie_ancien_proto=0 then Annee_proto =0;run;data tempo.concat_proto_cis;set tempo.concat_proto_cis;if Avenant = "" and Libelle_Du_Protocole ^="" then Avenant = Libelle_Du_Protocole;if Avenant ^= "" then Avenant = Avenant;drop ANNE_PROTOCOLE Ann_e_saisie_ancien_proto;run;data tempo.direct_assurance_vie;set tempo.concat_proto_cis;if  substr(CODE_PRODUIT,1,5)in ("93004");if Avenant = "" then Avenant="NR";drop Libelle_Du_Protocole;run;data tempo.CAPITAL_RESSOURCES;set tempo.concat_proto_cis;if  substr(CODE_PRODUIT,1,5)in ("91804");if Avenant = "" then Avenant="NR";drop Libelle_Du_Protocole;run;/* Pour Capital Ressources : il faut étudier tous les états du contrat */data tempo.Capi_VO;set tempo.CAPITAL_RESSOURCES;run;/* Pb : Il faut importer le fichier reporting Capital Ressources "fait manuellement" sous SAS  afin d'avoir les code ptf et les infos des courtiers car la concaténation avec les BD ne permet pas d'en obtenir *//* Pas de correspondance par code_apporteur */data tempo.Capi_V1;set tempo.Capi_VO;N__contrat = substr(NUMERO_CONTRAT,7,10)*1;drop Code_courtier Raison_sociale_courtier Code_cabinet Raison_sociale_cabinet;run;%rangement1(tempo.Capi_V1,N__contrat);data tempo.Repor_Capi;set tempo.Repor_Capi;rename N_contrat=N__contrat;run;data tempo.Capi_V2;merge tempo.Repor_Capi (in=a) tempo.Capi_V1 (in=b);by N__contrat;if a and b;run;%M_Zero(tempo.Capi_V2,tempo.Capi_V2);/* Suppression des lignes où les numctv = 0 */data tempo.Capi_V3;set tempo.Capi_V2;if N__contrat = 0 then delete;run;/* Récupération du "nom du courtier" pour Capital Ressources *//* Concaténation avec la BD par code courtier */%rangement1(tempo.Capi_V3,Code_Courtier);%rangement1(tempo.bd&mm&aa,Code_Courtier);data tempo.bd2&mm&aa;set tempo.bd&mm&aa;run;%concat_condition2(tempo.bd2&mm&aa,tempo.Capi_V3,tempo.Capi_V4,Code_Courtier,b);proc sort data = tempo.Capi_V4;by Code_courtier Raison_sociale_courtier Code_cabinet Cabinet N__contrat DATE_EFFET_CONTRAT date_terme Nom_client Age CODE_ISIN NOM_SUPPORT Gestion  Gestion Durée RegionEtat_Contrat TYPE_GARANTIE_DECES CP_Client Avenant Annee_proto NOM_PRODUIT Code_ptf Type_Gestion Type_Gestion_Collective Type_Option reseau Prenom_Inspecteur Nom_Inspecteur;run;proc summary data = tempo.Capi_V4;var VI VC Montant_global_TTC PM Retrait Repartition_UC Frais_VI Frais_VC;by Code_courtier Raison_sociale_courtier Code_cabinet Cabinet N__CONTRAT DATE_EFFET_CONTRAT /* Date_d_effet Gestion Dur_e R_gion*/ date_terme Nom_client Age CODE_ISIN NOM_SUPPORTEtat_Contrat TYPE_GARANTIE_DECES CP_Client Avenant Annee_proto NOM_PRODUIT Code_ptf  Arbitrage_entree Arbitrage_sortie Type_Gestion Type_Gestion_Collective Type_Option reseau Prenom_Inspecteur Nom_Inspecteur;OUTPUT OUT=tempo.CAPI_RES (drop=_type_ _freq_)SUM=;RUN;data tempo.CAPI_RES;length Region $20;set tempo.CAPI_RES;Libelle_region = Region;drop Region;run;data tempo.CAPI_RES;set tempo.CAPI_RES;if Libelle_region = "ILE DE France" then Libelle_region="Ile-de-France";if Libelle_region = "NORD EST" then Libelle_region="Nord-Est";if Libelle_region = "OUEST" then Libelle_region="Ouest";if Libelle_region = "SUD EST" then Libelle_region="Sud-Est";if Libelle_region = "SUD OUEST" then Libelle_region="Sud-Ouest";run;data tempo.CAPITAL_RESSOURCES_ok;set tempo.CAPI_RES;if Raison_sociale_courtier="" then Raison_sociale_courtier="NR";else Raison_sociale_courtier=Raison_sociale_courtier;if Cabinet="" then Cabinet="NR";else Cabinet=Cabinet;run;data tempo.CAPITAL_RESSOURCES_ok;set tempo.CAPITAL_RESSOURCES_ok;VLP="Pas de VLP pour ce produit" ;Frais_VLP="aucun car pas de VLP";Civilite="Inclue dans Nom et Prenom Client";rename Cabinet=Raison_sociale_cabinet retrait=Rachat Nom_client=Nom_Prenom_Client;run;proc sql ;create table tempo.CAPITAL_RESSOURCES_Export asselect Code_courtier,Raison_sociale_courtier, Code_cabinet, Raison_sociale_cabinet,Libelle_region, Nom_Produit,N__contrat ,DATE_EFFET_CONTRAT,DATE_TERME, Etat_Contrat,CODE_ISIN ,NOM_SUPPORT ,VI, VC, VLP, PM, Rachat,Civilite,Nom_Prenom_Client, age ,CP_Client, Avenant, Annee_proto,TYPE_GARANTIE_DECES,Code_ptf, Arbitrage_entree, Arbitrage_sortie, Frais_VI,Frais_VC,Frais_VLP,Type_Gestion ,Type_Gestion_Collective,Type_Option,reseau, Prenom_Inspecteur, Nom_Inspecteurfrom tempo.CAPITAL_RESSOURCES_ok;quit;PROC SORT DATA= tempo.CAPITAL_RESSOURCES_Export;BY Code_courtier Raison_sociale_courtier  Code_cabinet  Raison_sociale_cabinet Libelle_region  Nom_Produit  N__contrat  DATE_EFFET_CONTRAT DATE_TERME CODE_ISINEtat_Contrat NOM_SUPPORT Civilite Nom_Prenom_Client age CP_Client Avenant Annee_proto TYPE_GARANTIE_DECES Type_Gestion Type_Gestion_Collective  Type_Option Code_ptf Arbitrage_entree Arbitrage_sortiereseau Prenom_Inspecteur Nom_Inspecteur;run;PROC SUMMARY DATA=tempo.CAPITAL_RESSOURCES_Export;VAR VI VC PM  Rachat Arbitrage_Entree Arbitrage_Sortie Frais_VI Frais_VC;BY Code_courtier Raison_sociale_courtier  Code_cabinet  Raison_sociale_cabinet Libelle_region  Nom_Produit N__contrat DATE_EFFET_CONTRAT DATE_TERME CODE_ISINEtat_Contrat NOM_SUPPORT Civilite Nom_Prenom_Client  age  CP_Client Avenant  Annee_proto TYPE_GARANTIE_DECES Type_Gestion Type_Gestion_Collective Type_Option Code_ptf reseau Prenom_Inspecteur Nom_Inspecteur;OUTPUT OUT=tempo.CAPITAL_RESSOURCES_Export2 (drop=_type_ _freq_) SUM=;RUN;/************************************************************************* Direct assurance vie ************************************************************************************/%rangement1(tempo.Direct_assurance_vie,NUMERO_CONTRAT);proc sort data = tempo.direct_assurance_vie ;by Code_courtier Raison_sociale_courtier Code_cabinet NUMERO_CONTRAT DATE_EFFET_CONTRAT date_terme Nom_Prenom_Client Age CODE_ISIN NOM_SUPPORT Type_Gestion Libelle_regionEtat_Contrat TYPE_GARANTIE_DECES CP_Client Avenant Annee_proto NOM_PRODUIT Code_ptf Type_Gestion Type_Gestion_Collective Type_Option reseau Prenom_Inspecteur Nom_Inspecteur;run;proc summary data = tempo.direct_assurance_vie ;var VI VC PM Retrait Frais_VI Frais_VC Arbitrage_Entree Arbitrage_Sortie;by Code_courtier Raison_sociale_courtier Code_cabinet NUMERO_CONTRAT DATE_EFFET_CONTRAT date_terme Nom_Prenom_Client Age CODE_ISIN NOM_SUPPORT Type_Gestion Libelle_regionEtat_Contrat TYPE_GARANTIE_DECES CP_Client Avenant Annee_proto NOM_PRODUIT Code_ptf Type_Gestion Type_Gestion_Collective Type_Option reseau Prenom_Inspecteur Nom_Inspecteur;OUTPUT OUT= tempo.Direct_assurance_vie (drop=_type_ _freq_)SUM=;RUN;data tempo.Direct_assurance_vie;length Libelle_region $20;set tempo.Direct_assurance_vie;run;data tempo.Direct_assurance_vie;set tempo.Direct_assurance_vie;if Libelle_region = "ILE DE France" then Libelle_region="Ile-de-France";if Libelle_region = "NORD EST" then Libelle_region="Nord-Est";if Libelle_region = "OUEST" then Libelle_region="Ouest";if Libelle_region = "SUD EST" then Libelle_region="Sud-Est";if Libelle_region = "SUD OUEST" then Libelle_region="Sud-Ouest";run;data tempo.CISELIUM;set tempo.concat_proto_cis;if  substr(CODE_PRODUIT,1,5)in ("93254");if Avenant = "" then Avenant="NR";drop Libelle_Du_Protocole;run;data tempo.CISELIUM;set tempo.CISELIUM;VLP="Inclu dans VC" ;Frais_VLP="Inclu dans VC";Civilite="NR";rename retrait=Rachat;run;/************* Table détail *************/      proc sql ;create table tempo.CISELIUM_Export asselect Code_courtier,Raison_sociale_courtier, Code_cabinet, Raison_sociale_cabinet,Libelle_region, Nom_Produit ,NUMERO_CONTRAT ,DATE_EFFET_CONTRAT ,Date_terme, Etat_Contrat, CODE_ISIN ,NOM_SUPPORT ,VI, VC, VLP, PM, Rachat, Arbitrage_Entree,Arbitrage_Sortie ,Civilite,Nom_Prenom_Client, age ,CP_Client, Avenant, Annee_proto,TYPE_GARANTIE_DECES,Type_Gestion ,Type_Gestion_Collective ,Type_Option,Code_ptf ,Frais_VI,Frais_VC,Frais_VLP, reseau, Prenom_Inspecteur, Nom_Inspecteurfrom tempo.CISELIUM;quit;PROC SORT DATA=tempo.CISELIUM_Export;BY Code_courtier Raison_sociale_courtier  Code_cabinet  Raison_sociale_cabinet Libelle_region  Nom_Produit  NUMERO_CONTRAT  DATE_EFFET_CONTRAT Date_terme Etat_Contrat CODE_ISIN NOM_SUPPORT Civilite Nom_Prenom_Client age CP_Client Avenant Annee_proto TYPE_GARANTIE_DECES Type_Gestion Type_Gestion_Collective  Type_Option Code_ptfreseau Prenom_Inspecteur Nom_Inspecteur ;run;PROC SUMMARY DATA=tempo.CISELIUM_Export;VAR VI VC PM  Rachat Arbitrage_Entree Arbitrage_Sortie Frais_VI Frais_VC;BY Code_courtier Raison_sociale_courtier  Code_cabinet  Raison_sociale_cabinet Libelle_region  Nom_Produit NUMERO_CONTRAT DATE_EFFET_CONTRAT Date_terme CODE_ISINEtat_Contrat NOM_SUPPORT Civilite Nom_Prenom_Client  age  CP_Client Avenant  Annee_proto TYPE_GARANTIE_DECES Type_Gestion Type_Gestion_Collective  Type_Option Code_ptf reseau Prenom_Inspecteur Nom_Inspecteur;OUTPUT OUT=tempo.CISELIUM_Export2 (drop=_type_ _freq_) SUM=;RUN;/************* Table détail *************/DATA  tempo.Ciselium&mm&aa;SET  stock.saxostock;If substr(CODE_PRODUIT,1,5)in ("93254" "91804" "93004")then output;If SITUATION_CLOTURE^= "sans effet";if MANDAT_DE_GESTION_COLLECTIF='Gestion Libre' then test_gestion=1;else test_gestion=0;Keep PRIME_BRUTE_MONTANT VERSEMENTS_BRUTS_MONTANT MANDAT_DE_GESTION_COLLECTIF MANDAT_DE_GESTION_PERSONNALISE NUMERO_CONTRAT CODE_APPORTEUR RESEAU NOM_SUPPORTCODE_ISIN RETRAITS_MONTANT VAL_ACQUISE_CLOT_MONTANT MONTANT_NON_INVESTI_MONTANTDATE_EFFET_CONTRAT DATE_TERME CODE_APPORTEUR test_gestion;run;proc sort data=tempo.Ciselium&mm&aa;by numero_contrat test_gestion;run;data tempo.Ciselium&mm&aa;set tempo.Ciselium&mm&aa;retain test_mandat '0000000000000000000000000000000000000000';by numero_contrat;if first.numero_contrat then test_mandat=MANDAT_DE_GESTION_COLLECTIF;MANDAT_DE_GESTION_COLLECTIF=test_mandat;drop test_gestion test_mandat;run;DATA tempo.Ciselium&mm&aa;SET tempo.Ciselium&mm&aa;RENAME CODE_APPORTEUR=Code_ptf;RUN;%M_Zero(tempo.Ciselium&mm&aa,tempo.Ciselium&mm&aa);%rangement1(tempo.Ciselium&mm&aa,NUMERO_CONTRAT);/* Création de la table ne contenant que les contrats dont on va calculer les %UC par rapport aux CA */data tempo.Libre&mm&aa;set tempo.Ciselium&mm&aa;run;proc sql;create table tempo.Libre_V1&mm&aa asselect  distinct NUMERO_CONTRATfrom tempo.Libre&mm&aa;quit;/* Concaténation avec Ciselium&mm&aa afin de récupérer les montants versés sur les contrats */%rangement1(tempo.Libre_V1&mm&aa,NUMERO_CONTRAT);%rangement1(tempo.Ciselium&mm&aa,NUMERO_CONTRAT);data tempo.Libre_V2&mm&aa;merge tempo.Libre_V1&mm&aa (in=a) tempo.Ciselium&mm&aa;by NUMERO_CONTRAT;if a;run;data tempo.Libre_V3&mm&aa;set tempo.Libre_V2&mm&aa;Prod_tot_libre=PRIME_BRUTE_MONTANT + VERSEMENTS_BRUTS_MONTANT;Retrait_tot_libre=RETRAITS_MONTANT;PM_tot_libre=VAL_ACQUISE_CLOT_MONTANT-MONTANT_NON_INVESTI_MONTANT;if PM_tot_libre<0 then PM_tot_libre=0;drop PRIME_BRUTE_MONTANT VERSEMENTS_BRUTS_MONTANT RETRAITS_MONTANT VAL_ACQUISE_CLOT_MONTANT MONTANT_NON_INVESTI_MONTANT;run;/* CA total */proc sort data=tempo.Libre_V3&mm&aa;by NUMERO_CONTRAT Code_ptf CODE_ISIN NOM_SUPPORT;run;/* CA total */proc summary data=tempo.Libre_V3&mm&aa;var Prod_tot_libre Retrait_tot_libre PM_tot_libre;by NUMERO_CONTRAT Code_ptf ;output out= tempo.Libre_tot&mm&aa (drop=_type_ _freq_) sum=;  /**************************************************************************/run;/* CA_UC */proc summary data=tempo.Libre_V3&mm&aa;var Prod_tot_libre PM_tot_libre Retrait_tot_libre;by NUMERO_CONTRAT Code_ptf ;WHERE substr(CODE_ISIN,1,2) in ('FR','LU','IE');output out=tempo.Libre_UC&mm&aa (drop=_type_ _freq_) sum(Prod_tot_libre)=Prod_UC_libre           sum(PM_tot_libre)=PM_UC_libre           sum(Retrait_tot_libre)=Retrait_UC;run;proc sort data=tempo.Libre_tot&mm&aa;by NUMERO_CONTRAT Code_ptf ;run;proc sort data=tempo.Libre_UC&mm&aa;by NUMERO_CONTRAT Code_ptf ;run;data tempo.Libre_V4&mm&aa;merge tempo.Libre_tot&mm&aa tempo.Libre_UC&mm&aa;by NUMERO_CONTRAT Code_ptf ;run;%M_Zero(tempo.Libre_V4&mm&aa,tempo.Libre_V4&mm&aa);data tempo.Libre_V5&mm&aa;set tempo.Libre_V4&mm&aa;if Prod_tot_libre=0  then pourcent_UC_libre=0;else if Prod_tot_libre^=0 then pourcent_UC_libre=Prod_UC_libre/Prod_tot_libre;run;data tempo.Libre_V5&mm&aa;set tempo.Libre_V5&mm&aa;rename Prod_tot_libre=Prod_cis  Prod_UC_libre=Prod_UC_cis  pourcent_UC_libre=pourcent_UC_cis  PM_tot_libre=PM_cis  PM_UC_libre=PM_UC_cis  Retrait_tot_libre=Retrait_cis;run;data tempo.Libre_V5&mm&aa;set tempo.Libre_V5&mm&aa;keep NUMERO_CONTRAT Code_ptf Prod_cis Prod_UC_cis pourcent_UC_cisPM_cis PM_UC_cis Retrait_cis Retrait_UC;run;proc sort data=tempo.Libre_V5&mm&aa;by NUMERO_CONTRAT Code_ptf ;run;data tempo.Ciselium_V1&mm&aa;set tempo.Libre_V5&mm&aa ;run;%M_Zero(tempo.Ciselium_V1&mm&aa,tempo.Ciselium_V1&mm&aa);data tempo.Concat_proto_cis2;set tempo.Concat_proto_cis;if type_gestion=gestion_libre then test_gestion=1;else test_gestion=0;if pm<0 then pm=0;run;proc sort data=tempo.Concat_proto_cis2;by numero_contrat test_gestion;run;data tempo.Concat_proto_cis2;set tempo.Concat_proto_cis2;retain test_mandat '0000000000000000000000000000000000000000';by numero_contrat;if first.numero_contrat then test_mandat=type_gestion;type_gestion=test_mandat;drop test_gestion test_mandat;run;PROC SORT DATA=tempo.Concat_proto_cis2;BY Code_courtier Raison_sociale_courtier  Code_cabinet  Raison_sociale_cabinet Libelle_region  Nom_Produit  NUMERO_CONTRAT  DATE_EFFET_CONTRAT Date_terme Etat_Contrat Nom_Prenom_Client age CP_Client Avenant Annee_proto TYPE_GARANTIE_DECES Type_Gestion Type_Gestion_Collective  Type_Option Code_ptfreseau Prenom_Inspecteur Nom_Inspecteur;run;PROC SUMMARY DATA=tempo.Concat_proto_cis2;VAR VI VC PM Arbitrage_Entree Arbitrage_Sortie Retrait Frais_VI Frais_VC;BY Code_courtier Raison_sociale_courtier  Code_cabinet  Raison_sociale_cabinet Libelle_region  Nom_Produit NUMERO_CONTRAT DATE_EFFET_CONTRAT Date_terme Etat_Contrat Nom_Prenom_Client  age  CP_Client Avenant  Annee_proto TYPE_GARANTIE_DECES Type_Gestion Type_Gestion_Collective  Type_Option Code_ptf reseau Prenom_Inspecteur Nom_Inspecteur;OUTPUT OUT=tempo.CISELIUM_tot (drop=_type_ _freq_) SUM=;RUN;PROC SORT DATA=tempo.CISELIUM_tot;BY NUMERO_CONTRAT ;run;PROC SORT DATA=tempo.Ciselium_V1&mm&aa;BY NUMERO_CONTRAT ;run;data tempo.CISELIUM_tot1;set tempo.CISELIUM_tot;Code_ptf_num=input(Code_ptf, best16.) ;drop Code_ptf;run;data tempo.Ciselium_V1_1&mm&aa;set tempo.Ciselium_V1&mm&aa;Code_ptf_num=input(Code_ptf, best16.) ;drop Code_ptf;run;data tempo.CISELIUM_tot_UC;merge tempo.CISELIUM_tot1 (in=a) tempo.Ciselium_V1_1&mm&aa;BY NUMERO_CONTRAT ;if a;rename Code_ptf_num=Code_ptf;run;data tempo.CISELIUM_tot_UC;set tempo.CISELIUM_tot_UC;CA=VI+VC;CA_UC=Prod_UC_cis;PM_UC=PM_UC_cis;VI_UC=VI*pourcent_UC_cis;VC_UC=VC*pourcent_UC_cis;if (VI+VC)^=0 then part_CA_UC=(VI_UC+VC_UC)/(VI+VC);else part_CA_UC=0;if PM ^=0 then part_PM_UC=PM_UC/PM;else part_PM_UC=0;drop Prod_UC_cis PM_UC_cis Code_ptf Prod_cis Retrait_cis PM_cis ;run;data tempo.CISELIUM_tot_UC;set tempo.CISELIUM_tot_UC;drop pourcent_UC_cis;rename Retrait_UC= Rachat_UC Retrait= Rachat;run;data tempo.CISELIUM_tot_UC;set tempo.CISELIUM_tot_UC;if part_PM_UC >= (25/100) then condition_UC_PM_encours=1;else condition_UC_PM_encours=0;if PM >= 50000 then condition_PM_tot_encours=1;else condition_PM_tot_encours=0;run;data tempo.CISELIUM_tot_UC;set tempo.CISELIUM_tot_UC;length tranche_part_PM_UC $20;length tranche_CA $60;length tranche_PM $60;If CA >= 100000 Then tranche_CA="100ke et plus";else If CA>0 and CA < 500 Then tranche_CA="0-0.5ke";else if CA=0 then tranche_CA="Pas de prod";else if CA<0 then tranche_CA="Vérif Etat du contrat ou Annulation du versement";else If CA >= 500 and CA < 1000 Then tranche_CA="0.5-1ke";else If CA >= 1000 and CA < 3000 Then tranche_CA="1-3ke";else If CA >= 3000 and CA < 20000 Then tranche_CA="3-20ke";else If CA >= 20000 and CA < 50000 Then tranche_CA="20-50ke";else If CA >= 50000 and CA < 100000 Then tranche_CA="50ke-100ke";if part_PM_UC<(10/100) then tranche_part_PM_UC="<10%";else if (part_PM_UC>=(10/100) and part_PM_UC<(25/100)) then tranche_part_PM_UC="[10%;25%[";else if part_PM_UC>=(25/100) then tranche_part_PM_UC=">=25%";If PM >= 100000 Then tranche_PM="100ke et plus";else If PM>0 and PM < 500 Then tranche_PM="0-0.5ke";else if PM=0 then tranche_PM="Pas de prod";else if PM<0 then tranche_PM="Vérif Etat du contrat ou Annulation du versement";else If PM >= 500 and PM < 1000 Then tranche_PM="0.5-1ke";else If PM >= 1000 and PM < 3000 Then tranche_PM="1-3ke";else If PM >= 3000 and PM < 20000 Then tranche_PM="3-20ke";else If PM >= 20000 and PM < 50000 Then tranche_PM="20-50ke";else If PM >= 50000 and PM < 100000 Then tranche_PM="50ke-100ke";run;/********* Table pour synthèse **********/data tempo.CISELIUM_tot_UC;set tempo.CISELIUM_tot_UC;VLP=0;Frais_VLP=999999999;Systeme="Axiome V4";run;PROC SORT DATA=tempo.CISELIUM_tot_UC;BY Code_courtier Raison_sociale_courtier  Code_cabinet  Raison_sociale_cabinet ;run;/*----------------------------*//*        FIN Axiome V4       *//*----------------------------*//*--------------------------------*//* Conversions dates en numérique *//*--------------------------------*/DATA tempo.PA_AM_tot_UC2;set tempo.PA_AM_tot_UC_bis;m1=substr(DATE_EFFET_CONTRAT,4,2);m2=substr(Date_terme,4,2);mm1=m1*1;mm2=m2*1;d1=substr(DATE_EFFET_CONTRAT,1,2);d2=substr(Date_terme,1,2);dd1=d1*1;dd2=d2*1;y1=substr(DATE_EFFET_CONTRAT,7,4);y2=substr(Date_terme,7,4);yy1=y1*1;yy2=y2*1;run;data tempo.PA_AM_tot_UC2;set  tempo.PA_AM_tot_UC2;format var1 ddmmyy10.;format var2 ddmmyy10.;var1= MDY(mm1,dd1,yy1);var2= MDY(mm2,dd2,yy2);run;Data tempo.PA_AM_tot_UC2;set  tempo.PA_AM_tot_UC2;drop mm1 mm2 m1 m2 y1 y2 yy1 yy2 d1 d2 dd1 dd2 DATE_EFFET_CONTRAT Date_terme  ;rename var1=DATE_EFFET_CONTRAT var2= Date_terme;run;proc sql noprint;   CREATE TABLE tempo.PA_AM_tot_UC2bis AS      SELECT *, sum(PM) AS cumul_PM, sum(PM_UC) AS cumul_PM_UC, sum(part_PM_UC) AS cumul_part_PM_UC      FROM tempo.PA_AM_tot_UC2      GROUP BY NUMERO_CONTRAT;quit;DATA  tempo.PA_AM_tot_UC2bis;SET tempo.PA_AM_tot_UC2bis;DROP PM PM_UC part_PM_UC;RENAME cumul_PM=PM cumul_PM_UC=PM_UC cumul_part_PM_UC=part_PM_UC;RUN;PROC SORT DATA=tempo.PA_AM_tot_UC2bisOUT=tempo.PA_AM_tot_UC_3 nodupkey;by NUMERO_CONTRAT;RUN;DATA tempo.Synt_NACT_tot_UC2;set tempo.Synt_NACT_tot_UC;m1=substr(DATE_EFFET_CONTRAT,4,2);m2=substr(Date_terme,4,2);mm1=m1*1;mm2=m2*1;d1=substr(DATE_EFFET_CONTRAT,1,2);d2=substr(Date_terme,1,2);dd1=d1*1;dd2=d2*1;y1=substr(DATE_EFFET_CONTRAT,7,4);y2=substr(Date_terme,7,4);yy1=y1*1;yy2=y2*1;run;data tempo.Synt_NACT_tot_UC2;set  tempo.Synt_NACT_tot_UC2;format var1 ddmmyy10.;format var2 ddmmyy10.;var1= MDY(mm1,dd1,yy1);var2= MDY(mm2,dd2,yy2);run;Data tempo.Synt_NACT_tot_UC2;set  tempo.Synt_NACT_tot_UC2;drop mm1 mm2 m1 m2 y1 y2 yy1 yy2 d1 d2 dd1 dd2 DATE_EFFET_CONTRAT Date_terme  ;rename var1=DATE_EFFET_CONTRAT var2= Date_terme;run;Data tempo.Synt_NACT_tot_UC2b;set  tempo.Synt_NACT_tot_UC2;NUMERO_CONTRAT2=put(NUMERO_CONTRAT,25.);drop NUMERO_CONTRAT;rename NUMERO_CONTRAT2=NUMERO_CONTRAT;run;DATA tempo.Table_RCV82;set tempo.Table_RCV8;m1=substr(DATE_EFFET_CONTRAT,4,2);m2=substr(Date_terme,4,2);mm1=m1*1;mm2=m2*1;d1=substr(DATE_EFFET_CONTRAT,1,2);d2=substr(Date_terme,1,2);dd1=d1*1;dd2=d2*1;y1=substr(DATE_EFFET_CONTRAT,7,4);y2=substr(Date_terme,7,4);yy1=y1*1;yy2=y2*1;run;data tempo.Table_RCV82;set  tempo.Table_RCV82;format var1 ddmmyy10.;format var2 ddmmyy10.;var1= MDY(mm1,dd1,yy1);var2= MDY(mm2,dd2,yy2);run;Data tempo.Table_RCV82;set  tempo.Table_RCV82;drop mm1 mm2 m1 m2 y1 y2 yy1 yy2 d1 d2 dd1 dd2 DATE_EFFET_CONTRAT Date_terme rachat_UC;rename var1=DATE_EFFET_CONTRAT var2= Date_terme;run;/*-------------------------------------------------------------------*//*      Création Table Synthèse        *//*-------------------------------------------------------------------*//* On crée une table finale du système Axiome V4, on enlève d'abord tous les "capital ressources" de la table (ils n'appartiennent pas tous au courtage, il faut donc sélectionner les bons contrats) */DATA tempo.CISELIUM_tot_UC_V2;SET tempo.CISELIUM_tot_UC;where NOM_PRODUIT<>"Capital Ressources";RUN;/* On ne garde que les contrats que l'on garde pour le détail, ceux qui appartiennent vraiment au courtage */DATA tempo.CAPI_RES_V2;length Numero_contrat $30.;SET tempo.CAPITAL_RESSOURCES_Export2;Numero_contrat=N__Contrat;DROP N__Contrat;RUN;/* On regroupe les tables avec et sans "capital ressources" pour avoir la table correcte utilisable pour la synthèse */DATA tempo.CISELIUM_tot_UC_VF;SET tempo.CISELIUM_tot_UC_V2 tempo.CAPI_RES_V2;RUN;/* Création de la table synthèse */ data tempo.synt;length NUMERO_CONTRAT $30;set tempo.PA_AM_tot_UC_3 tempo.Synt_NACT_tot_UC2b tempo.CISELIUM_tot_UC_VF tempo.Table_RCV82;Arb_Entree=Arbitrage_Entree;Arb_Sortie=Arbitrage_Sortie;Frais_VIb=Frais_VI;Frais_VCb=Frais_VC;Frais_VLPb=Frais_VLP;drop Arbitrage_Entree Arbitrage_Sortie Frais_VI Frais_VC Frais_VLP;run;DATA tempo.synt_1;length NUMERO_CONTRAT $30;SET tempo.synt; run; /* On supprime les doublons */proc sort data= tempo.synt_1 out = tempo.synt_2 nodupkey;by NUMERO_CONTRAT PM;run; PROC SORT DATA=tempo.synt_2;BY  Code_courtier Raison_sociale_courtier Code_cabinet Raison_sociale_cabinet Libelle_region  Nom_Produit NUMERO_CONTRAT DATE_EFFET_CONTRAT Date_terme Etat_Contrat Civilite Nom_Prenom_Client age CP_Client Avenant Annee_proto TYPE_GARANTIE_DECES Type_Gestion Type_Gestion_Collective  Type_Optiontranche_part_PM_UC tranche_CA tranche_PM InfoFlux_VI_VC_VLP_Rachat reseau systeme Code_ptf Prenom_Inspecteur Nom_Inspecteur  Type_Inspecteur Type_Rachat;run;%M_zero(tempo.synt_2,tempo.synt_2);PROC summary DATA=tempo.synt_2;var VI VI_UC VC VC_UC VLP VLP_UC CA CA_UC PM PM_UC Rachat Arb_Entree Arb_Sortie  part_CA_UC part_PM_UC condition_UC_PM_encours condition_PM_tot_encours Frais_VIb Frais_VCb Frais_VLPb /*cp*/;by Code_courtier Raison_sociale_courtier Code_cabinet Raison_sociale_cabinet Libelle_region  Nom_Produit  NUMERO_CONTRAT DATE_EFFET_CONTRAT Date_terme Etat_Contrat Civilite Nom_Prenom_Client age CP_Client Avenant Annee_proto TYPE_GARANTIE_DECES Type_Gestion Type_Gestion_Collective  Type_Optiontranche_part_PM_UC tranche_CA tranche_PM InfoFlux_VI_VC_VLP_Rachat reseau systeme Code_ptf Prenom_Inspecteur Nom_Inspecteur  Type_Inspecteur Type_Rachat ;output out=tempo.synt_V1 (drop=_type_ _freq_)  sum=;run; data tempo.synt_V1;length NUMERO_CONTRAT $30;set tempo.synt_V1;if (Arb_Entree>=999999999) then Arbitrage_Entree="Flux non dispo."; else Arbitrage_Entree=Arb_Entree;if (Arb_Sortie>=999999999) then Arbitrage_Sortie="Flux non dispo."; else Arbitrage_Sortie=Arb_Sortie;if (Frais_VIb>=999999999) then Frais_VI="Flux non dispo."; else Frais_VI=Frais_VIb;if (Frais_VCb>=999999999) then Frais_VC="Flux non dispo."; else Frais_VC=Frais_VCb;if ((Frais_VLPb>=999999999) and (Nom_produit="Ciselium")) then Frais_VLP="Pas de VLP sur ce produit"; else if (Frais_VLPb>=999999999) then Frais_VLP="Flux non dispo."; else Frais_VLP=Frais_VLPb;drop Arb_Entree Arb_Sortie Frais_VIb Frais_VCb Frais_VLPb;run;proc sort data= tempo.synt_V1 out = tempo.synt_V1bis;by NUMERO_CONTRAT descending PM;run; /* On ne garde pas les contrats "résiliés" */DATA tempo.synt_V1bis2;length NUMERO_CONTRAT $30;SET tempo.synt_V1bis;where PM<>0;run; /* On regroupe les différents supports d'un même contrat en faisant la somme des PM pour n'avoir qu'une lignepar contrat dans la Synthèse */proc sql noprint;   CREATE TABLE tempo.synt_V1bis_2 AS      SELECT *, sum(PM) AS cumul_PM, sum(PM_UC) AS cumul_PM_UC, sum(part_PM_UC) AS cumul_part_PM_UC      FROM tempo.synt_V1bis2      GROUP BY NUMERO_CONTRAT;quit; DATA  tempo.synt_V1bis_2a;length NUMERO_CONTRAT $30;SET tempo.synt_V1bis_2;DROP PM PM_UC part_PM_UC;RENAME cumul_PM=PM cumul_PM_UC=PM_UC cumul_part_PM_UC=part_PM_UC;RUN; /* On récupère les contrats "rachetés" que l'on veut garder dans la synthèse */DATA tempo.synt_V1bis3;length NUMERO_CONTRAT $30;SET tempo.synt_V1bis;where Etat_Contrat="Racheté";run;proc sql noprint;   CREATE TABLE tempo.synt_V1bis_2b AS      SELECT *, sum(PM) AS cumul_PM, sum(PM_UC) AS cumul_PM_UC, sum(part_PM_UC) AS cumul_part_PM_UC      FROM tempo.synt_V1bis3      GROUP BY NUMERO_CONTRAT;quit; DATA  tempo.synt_V1bis_2ba;length NUMERO_CONTRAT $30;SET tempo.synt_V1bis_2b;DROP PM PM_UC part_PM_UC;RENAME cumul_PM=PM cumul_PM_UC=PM_UC cumul_part_PM_UC=part_PM_UC;RUN;DATA tempo.synt_V1fin;length NUMERO_CONTRAT $30;SET tempo.synt_V1bis_2a tempo.synt_V1bis_2ba;RUN;/* On supprime à nouveau les doublons restants */proc sort data= tempo.synt_V1fin out = tempo.synt_V1fin2 nodupkey;by NUMERO_CONTRAT;run;/*-------------------------------------------------------------------*//*      FIN Creation Table Synthèse       *//*-------------------------------------------------------------------*//*----------------------------------------------------------------------------*//*    Exportation des tables "Détails"   PAM - AMADEO - SELO - PERP -         *//*  CISELIUM - CAPITAL RESSOURCES - UNOFI - LIBREPARGNE - DIRECT ASSURANCE    *//*----------------------------------------------------------------------------*//*%exportation(tempo.PAM_AMADEO_Export2bis,&chemin_export,&nom_fiche,PAM_AMADEO,&mm,&aa);%exportation(tempo.SELO_Export_asso2,&chemin_export,&nom_fiche,SELO,&mm,&aa);%exportation(tempo.PERP_Export_asso2,&chemin_export,&nom_fiche,PERP,&mm,&aa);%exportation(tempo.Autres_Export_asso2,&chemin_export,&nom_fiche,Autres_NOVA,&mm,&aa);%exportation(tempo.CISELIUM_Export2,&chemin_export,&nom_fiche,CISELIUM,&mm,&aa);%exportation(tempo.CAPITAL_RESSOURCES_Export2,&chemin_export,&nom_fiche,CAPI_RES,&mm,&aa);%exportation(tempo.direct_assurance_vie,&chemin_export,&nom_fiche,direct_Ass,&mm,&aa);%exportation(tempo.LibreEpargne,&chemin_export,&nom_fiche,Libre_Epargne,&mm,&aa);%exportation(tempo.UNOFI,&chemin_export,&nom_fiche,UNOFI,&mm,&aa);%exportation(tempo.Autres_RCV,&chemin_export,&nom_fiche,Autres_RCV,&mm,&aa);*//*-----------------------------------------------------------*//*         Exportation Table "Synthèse"                *//*-----------------------------------------------------------*//*%exportation(tempo.synt_V1fin2,&chemin_export,&nom_fiche_synt,Synt,&mm,&aa);*//* Macros xports ne marchent pas*//***************************************************************************************************************************************************          EXTRACTION DE CAPITAL RESSOURCES SUR NOVA/**************************************************************************************************************************************************/libname vista_rs "/mutu/FR/batch/data/prod/IF12/VIE/IRS300/VISTAINV/M&aa.&mm." access=readonly;libname vista_aa "/mutu/FR/batch/data/prod/IF12/VIE/IAA300/VISTAINV/M&aa.&mm." access=readonly;libname vista_co "/mutu/FR/batch/data/prod/IF12/VIE/ICO300/VISTAINV/M&aa.&mm." access=readonly;libname vista_cu "/mutu/FR/batch/data/prod/IF12/VIE/ICU300/VISTAINV/M&aa.&mm." access=readonly;libname ilis_aa "/mutu/FR/batch/data/prod/IF12/VIE/IAA300/ILISINV/M&aa.&mm." access=readonly;libname ilis_co "/mutu/FR/batch/data/prod/IF12/VIE/ICO300/ILISINV/M&aa.&mm." access=readonly;libname ilis_cu "/mutu/FR/batch/data/prod/IF12/VIE/ICU300/ILISINV/M&aa.&mm." access=readonly;libname ilis_rs "/mutu/FR/batch/data/prod/IF12/VIE/IRS300/ILISINV/M&aa.&mm." access=readonly;libname ildt_aa"/mutu/FR/batch/data/prod/IF12/VIE/IAA300/ILDTINV/M&aa.&mm." access=readonly;libname visdt_aa"/mutu/FR/batch/data/prod/IF12/VIE/IAA300/VISDTINV/M&aa.&mm." access=readonly;data pm_capires;set vista_rs.pm vista_aa.pm vista_co.pm vista_cu.pmilis_aa.pm ilis_co.pm ilis_cu.pm ilis_rs.pmildt_aa.pmvisdt_aa.pm;where codprod in ("96004" "96024" "96014");run;data pm_cap_support;set vista_rs.pms vista_aa.pms vista_co.pms vista_cu.pmsilis_aa.pms ilis_co.pms ilis_cu.pms ilis_rs.pmsildt_aa.pmsvisdt_aa.pms;where codprod in ("96004" "96024" "96014");run;data tab_support;set pm_cap_support (keep= numctv reseau codprod region resf codsup);run;PROC SORT DATA=tab_support;BY codprod numctv codsup;run;PROC SUMMARY DATA=tab_support;VAR resf;BY codprod numctv codsup reseau ;OUTPUT OUT=tab_support_2(drop=_type_ _freq_) SUM=;RUN;data tab_pm;set pm_capires (keep= codprod numctv codport mtinv reseau );run;PROC SORT DATA=tab_pm;BY codprod numctv codport ;run;PROC SUMMARY DATA=tab_pm;VAR mtinv;BY codprod numctv codport mtinv reseau ;OUTPUT OUT=tab_pm_2(drop=_type_ _freq_) SUM=;RUN;proc sort data=tab_pm_2; by codprod numctv ;run;proc sort data=tab_support_2; by codprod numctv ;run;data capires;merge tab_support_2(in=a) tab_pm_2(in=b);by codprod numctv;if a;run;PROC IMPORT OUT=supportDATAFILE= "~/NAS/M/eQUIPES/Produits & Normes/Nguyen_K/Reporting courtage/Reporting Courtage/Capital_ressource/Capital_ressources.xlsx"DBMS=xlsx REPLACE; GETNAMES=YES;RUN;data support_2;set support /*(rename=N__contrat= numctv)*/;run;libname vie   "/mutu/FR/batch/data/prod/IF12/VIE/IAA300/TABVIE";data tempo.Lib_Prod_Support;set vie.viestc;run;Data tempo.Lib_Prod_Support;set tempo.Lib_Prod_Support;keep CODPROD CODSUP LIBPROD LIBSUPP NAT_SUPP;run;proc sort data=tempo.Lib_Prod_Support; by codsup;run;proc sort data=capires; by codsup ;run;data tab (rename= reseau = reseau_2);merge capires(in=a) tempo.Lib_Prod_Support(in=b);by codsup;if a;run;proc sort data=support_2;by numctv;run;proc sort data=tab;by numctv;run;data cap_res;merge support_2(in=a) tab(in=b);by numctv;if a;run;/***********************************************************************************************************************************************/PROC EXPORT DATA=tempo.PAM_AMADEO_Export2bisOUTFILE= "&chemin_export.&nom_fiche.&mm.&aa..xlsx"DBMS=xlsx REPLACE;SHEET="PAM_AMADEO";RUN;PROC EXPORT DATA=tempo.SELO_Export_asso2OUTFILE= "&chemin_export.&nom_fiche.&mm.&aa..xlsx"DBMS=xlsx REPLACE;SHEET="SELO";RUN;PROC EXPORT DATA=tempo.PERP_Export_asso2OUTFILE= "&chemin_export.&nom_fiche.&mm.&aa..xlsx"DBMS=xlsx REPLACE;SHEET="PERP";RUN;PROC EXPORT DATA=tempo.Autres_Export_asso2OUTFILE= "&chemin_export.&nom_fiche.&mm.&aa..xlsx"DBMS=xlsx REPLACE;SHEET="Autres_NOVA";RUN;PROC EXPORT DATA=tempo.CISELIUM_Export2OUTFILE= "&chemin_export.&nom_fiche.&mm.&aa..xlsx"DBMS=xlsx REPLACE;SHEET="CISELIUM";       /*-------------- L'export de CISELIUM est inclus dans Autres Nova*/ /*??????*/RUN;PROC EXPORT DATA=tempo.CAPITAL_RESSOURCES_Export2OUTFILE= "&chemin_export.&nom_fiche.&mm.&aa..xlsx"DBMS=xlsx REPLACE;SHEET="CAPI_RES";RUN;PROC EXPORT DATA=tempo.direct_assurance_vieOUTFILE= "&chemin_export.&nom_fiche.&mm.&aa..xlsx"DBMS=xlsx REPLACE;SHEET="direct_Ass";RUN;PROC EXPORT DATA=tempo.LibreEpargneOUTFILE= "&chemin_export.&nom_fiche.&mm.&aa..xlsx"DBMS=xlsx REPLACE;SHEET="Libre_Epargne";RUN;PROC EXPORT DATA=tempo.Autres_RCVOUTFILE="&chemin_export.&nom_fiche.&mm.&aa..xlsx"DBMS=xlsx REPLACE;SHEET="Autres_RCV";RUN;PROC EXPORT DATA=tempo.synt_V1fin2OUTFILE= "&chemin_export.&nom_fiche_synt.&mm.&aa..xlsx"DBMS=xlsx REPLACE;SHEET="Synt";RUN;PROC EXPORT DATA=cap_resOUTFILE= "&chemin_export.&nom_fiche.&mm.&aa..xlsx"DBMS=xlsx REPLACE;SHEET="CAPITAL_RESSOURCES";RUN;
