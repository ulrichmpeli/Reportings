%macro pm_sup(an=,mois=,systeme=);%let u=%eval(&mois.);data pm_&systeme.; set pm_&systeme.&an.&mois.(keep=police codprod code_support libprod produit nom_support reseau branche type_gestion_long type_gestion gestion codport dtemi dteff datnai1 mois pm pm_uc systeme anpere type_produit rename=(pm=pma pm_uc=pma_uc)); where pma>0; array pm{0:&u.} pm0-pm&u.; array pm_uc{0:&u.} pm_uc0-pm_uc&u.; do i=0 to &u.;  pm{i}=0;  pm_uc{i}=0;  if mois=i then do;   pm{i}=pma;   pm_uc{i}=pma_uc;  end; end; drop pma pma_uc;run;proc sort data=pm_&systeme.; by reseau codprod libprod type_gestion_long type_gestion gestion code_support produit branche anpere;run;       /*PM par support*/proc summary data=pm_&systeme.; by reseau codprod libprod type_gestion_long type_gestion gestion code_support produit branche anpere; var pm:; id nom_support systeme type_produit; output out=pm_&systeme._sum(drop=_type_  _freq_) sum=;run;       /*pm par produit*/proc sort data=pm_&systeme.; by police;run;proc summary data=pm_&systeme.; by police; var pm:; id reseau codprod type_gestion_long type_gestion gestion libprod produit branche systeme type_produit anpere datnai1; output out=pm_&systeme._contrat(drop=_type_  _freq_) sum=;run;data pm_&systeme._contrat;set pm_&systeme._contrat;array pm{0:&u.} pm0-pm&u.;array nb{0:&u.} nb0-nb&u.;do i=0 to &u.; nb{i}=0; if pm{i}>0 then nb{i}=1;end;age=max(int((20&an.&mois.31-datnai1)/10000),0);age_nb=1;if datnai1<19020000 or datnai1=. or datnai1="" or pm{&u.}=0 or pm{&u.}=. then age_nb=0;age=age*age_nb;run;proc sort data=pm_&systeme._contrat;by reseau codprod libprod type_gestion_long type_gestion gestion produit branche anpere;run;proc summary data=pm_&systeme._contrat; by reseau codprod libprod type_gestion_long type_gestion gestion produit branche anpere; var pm: nb: age:; id systeme type_produit; output out=pm_&systeme._contrat_sum(drop=_type_  _freq_) sum=;run;%mend;       %macro flux_sup(an=,mois=,systeme=);data flux_&systeme.; set flux_&systeme.&an.&mois.(keep=police codprod code_support libprod produit nom_support reseau branche type_gestion_long type_gestion gestion codport dtemi dteff datnai1 mois montant_brut montant_brut_uc fraisvar fraisfix date_mvt date_saisie sens mvt systeme type_produit anpere); where montant_brut ne 0;run;/** préparation des bases pour flux par produit **/proc sort data=flux_&systeme.; by police date_saisie mvt sens;run;proc summary data=flux_&systeme.; by police date_saisie mvt sens; var montant_brut montant_brut_uc fraisvar fraisfix; id codprod libprod produit reseau branche type_gestion_long type_gestion gestion codport dtemi dteff datnai1 mois systeme type_produit anpere; output out=flux_&systeme._2(drop=_type_ _freq_) sum=;run;/** end **/            /*flux par support*/%do j=1 %to 10;%let i=%scan(&mouvement.,&j.,-) ;data flux_&systeme.; set flux_&systeme.; &i.=0; &i._UC=0; if mvt="&i." then do;  &i.=montant_brut;  &i._UC=montant_brut_uc; end;run;%end;%if &systeme.=axv1 or &systeme.=axv4 %then %do; proc sort data=flux_&systeme.; by police code_support; run; proc summary data=flux_&systeme.;  by police code_support;  var an an_: vl: pp: as: ae: rg: rp: rt: si: e:;  id reseau codprod libprod type_gestion_long type_gestion gestion produit branche nom_support systeme type_produit anpere;  output out=flux_&systeme.(drop=_type_  _freq_) sum=; run; %do j=1 %to 10; %let i=%scan(&mouvement.,&j.,-);   %if &i.=AN or &i.=VL or &i.=PP or &i.=AE %then %do;     data flux_&systeme.;    set flux_&systeme.;    &i.=max(0,&i.);    &i._uc=max(0,&i._uc);   run;  %end;  %else %do;   data flux_&systeme.;    set flux_&systeme.;    &i.=min(0,&i.);    &i._uc=min(0,&i._uc);   run;    %end;    %end;%end;proc sort data=flux_&systeme.; by reseau codprod libprod type_gestion_long type_gestion gestion code_support produit branche anpere;run;proc summary data=flux_&systeme.; by reseau codprod libprod type_gestion_long type_gestion gestion code_support produit branche anpere; var an an_: vl: pp: as: ae: rg: rp: rt: si: e:; id nom_support systeme type_produit; output out=flux_&systeme._sum(drop=_type_  _freq_) sum=;run;            /*flux par produit*/%if &systeme.=nova %then %do; data engagement_annuel(drop=mois);  set pm_&systeme.&an.&mois.(keep=police optmina mois);  where mois=&mois.;  rename optmina=eng_an; run; proc sort data=engagement_annuel nodupkey;  by police; run; data flux_&systeme._2;  merge flux_&systeme._2(in=a) engagement_annuel(in=b);  by police;  if a;  if mvt ne 'AN' then eng_an=0;  else eng_an=eng_an*sens; run;%end;%else %if &systeme.=rcv %then %do; data engagement_annuel(drop=mois);  set flux_&systeme.&an.&mois.(keep=police eng_an); run; proc sort data=engagement_annuel;  by police; run; proc summary data=engagement_annuel;  by police;  var eng_an;  output out=engagement_annuel(drop=_type_ _freq_) sum=; run; data flux_&systeme._2;  merge flux_&systeme._2(in=a) engagement_annuel(in=b);  by police;  if a;  eng_an=eng_an*sens; run;%end;%else %do; data flux_&systeme._2;  set flux_&systeme._2;  eng_an=0; run;%end;data flux_&systeme._2; set flux_&systeme._2; nb_acte=sens;run;proc sort data=flux_&systeme._2; by police mvt;run;proc summary data=flux_&systeme._2; by police mvt; var montant_brut montant_brut_uc fraisvar fraisfix nb_acte eng_an; id codprod libprod produit reseau branche type_gestion_long type_gestion gestion codport dtemi dteff datnai1 mois systeme type_produit anpere; output out=flux_&systeme._3(drop=_type_ _freq_) sum=;run;%do j=1 %to 10;%let i=%scan(&mouvement.,&j.,-) ;data flux_&systeme._3; set flux_&systeme._3; &i.=0; &i._UC=0; &i._nb_acte=0; &i._nb_contrat=0; &i._fraisvar=0; &i._fraisfix=0; if mvt="&i." then do;  &i.=montant_brut;  &i._UC=montant_brut_uc;  &i._nb_acte=nb_acte;  &i._fraisvar=fraisvar;  &i._fraisfix=fraisfix; end;run;%end;proc sort data=flux_&systeme._3; by police;run;proc summary data=flux_&systeme._3; by police; var an an_: vl: pp: as: ae: rg: rp: rt: si: e e_: eng_an; id codprod libprod produit reseau branche type_gestion_long type_gestion gestion codport dtemi dteff datnai1 mois systeme type_produit anpere; output out=flux_&systeme._4(drop=_type_  _freq_) sum=;run;%do j=1 %to 10;%let i=%scan(&mouvement.,&j.,-) ; %if &i.=AN or &i.=VL or &i.=PP or &i.=AE %then %do;    %if &systeme.=axv1 or &systeme.=axv4 %then %do;   data flux_&systeme._4;    set flux_&systeme._4;    if &i.>0 then &i._nb_contrat=1;     if &i.<0 then do;      &i.=0;      &i._nb_contrat=0;      &i._uc=0;      &i._nb_acte=0;      &i._fraisvar=0;      &i._fraisfix=0;     end;   run;  %end;  %else %do;   data flux_&systeme._4;    set flux_&systeme._4;    if &i.>0 then &i._nb_contrat=1;   run;    %end;    %end; %else %do;  %if &systeme.=axv1 or &systeme.=axv4 %then %do;   data flux_&systeme._4;    set flux_&systeme._4;    if &i.<0 then &i._nb_contrat=1;     if &i.>0 then do;      &i.=0;      &i._nb_contrat=0;      &i._uc=0;      &i._nb_acte=0;      &i._fraisvar=0;      &i._fraisfix=0;     end;   run;  %end;  %else %do;   data flux_&systeme._4;    set flux_&systeme._4;    if &i.<0 then &i._nb_contrat=1;   run;  %end; %end;%end;data flux_&systeme._4; set flux_&systeme._4; an_age=max(int((dtemi-datnai1)/10000),0); an_age_nb=an_nb_contrat; if datnai1<19020000 or datnai1=. or datnai1="" or dtemi=. or dtemi="" then an_age_nb=0; an_age=an_age*an_age_nb; production_an=0; if an ne 0 then production_an=an+vl+pp; production=an+vl+pp; production_nb_contrat=0; if production>0 then production_nb_contrat=1; production_age=max(int((20&an.0700-datnai1)/10000),0); production_age_nb=production_nb_contrat; if datnai1<19020000 or datnai1=. or datnai1="" or production_nb_contrat<1 then production_age_nb=0; production_age=production_age*production_age_nb;run;proc sort data=flux_&systeme._4; by reseau codprod libprod type_gestion_long type_gestion gestion produit branche anpere;run;proc summary data=flux_&systeme._4; by reseau codprod libprod type_gestion_long type_gestion gestion produit branche anpere; var an an_: vl: pp: as: ae: rg: rp: rt: si: e e_: eng_an production:; id systeme type_produit; output out=flux_&systeme._5(drop=_type_  _freq_) sum=;run;%mend;        
