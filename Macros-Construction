/********************************************************************************//*   1A : Recuperation des PM sur RCV         *//********************************************************************************//* Macro permettant d'extraire les contrats par support d'une librairie pour un mois et une annee donnes */%macro pm_rcv(out=,lib=,aa=,mm=); /* Extraction des variables qualitatives des contrats dans la base PM */data temp_pm;set &lib..pm(keep=numctv gesprofi codprod codport reseau dteff dtemi datnai1 datnai2 codfisc typcot codeta DATENCL NUMCONO MTCAPRE OPTMINA mtinv mtccotf codsoc durctv datech);rename gesprofi=profil_gest;mois=&mm.;dteff2=dteff*1;dtemi2=dtemi*1;format codsociete $3.;if codsoc in ('1' '3') then codsociete='MU';else codsociete='SA';cumul_prime_verse=mtccotf;drop dteff dtemi codsoc mtccotf;rename dteff2=dteff dtemi2=dtemi;run;/* Ajout du libelle de gestion et du nom du produit */proc sort data=temp_pm;by codprod profil_gest;run;proc sort data=gestion;by codprod profil_gest;run;data temp_pm;merge temp_pm(in=a) gestion(in=b drop=mandat_de_gestion:);by codprod profil_gest;if a;run;/* Extraction des PM par support de la base PMS */data temp_pms;set &lib..pms(keep=numctv codsup resf);mois=&mm.;if codsup ne "";PM_UC=0;rename resf=PM;run;/* Ajout du nom du support et du type de support */proc sort data=temp_pms;by codsup;run;data temp_pms;merge temp_pms(in=a) support(in=b);by codsup;if a;run;data temp_pms;set temp_pms;if TYPE='E' then support='EURO';else support='UC';if support='UC' then PM_UC=PM;drop type;run;/* Jointure entre les donnees qualitatives des contrats et les donnees quantitatives par support */proc sort data=temp_pms;by numctv;run;proc sort data=temp_pm;by numctv;run;data &out.;merge temp_pm(in=a) temp_pms(in=b);by numctv;if a or b;if codsup="" then pm=mtinv; /* Les contrats monosupports euro sans garanties de prevoyance n'apparaissent pas dans la base PMS */run;%mend;/* Macro utilisant la macro precedente, elle permet de concatener les PM par support du mois de decembre de l'annee precedente (i.e. PM d'ouverture) au mois indique en input */%macro recup_pm_rcv(an=,mois=,no_lancement=,pole=,table=);%do i=1 %to &mois.; /* Boucle allant du debut de l'annee au mois indique en input */ %if &i<10 %then %do;  %let j=0&i.; %end; %else %do;  %let j=&i.; %end; libname lib "/mutu/FR/batch/data/prod/IF12/VIE/I&pole.300/&table./M&an.&j." access=readonly; %pm_rcv(out=pm,lib=lib,aa=&an.,mm=&j.); /* Extraction des PM par contrat et support pour l'annee et le mois indique */     %if &i.=1 %then %do;  data pm&no_lancement.; /* Si on est en debut de boucle alors on cree la table */  set pm;                run; %end; %else %do;  data pm&no_lancement.; /* Sinon, on concatene */  set pm pm&no_lancement.;  run; %end;%end;libname lib "/mutu/FR/batch/data/prod/IF12/VIE/I&pole.300/&table./M&an1.12" access=readonly;%pm_rcv(out=pm,lib=lib,aa=&an1.,mm=12); /* On recupere la PM de fin decembre de l'annee precedente (i.e. PM d'ouverture) */data pm;set pm;mois=0;run;data pm&no_lancement.;set pm pm&no_lancement.;run;%mend;/********************************************************************************//*   2A : Recuperation des PM sur NOVA         *//********************************************************************************/%macro pm_nova(out=,lib=,aa=,mm=);data temp_pm;set &lib..pm(keep=numctv profil_gest /*gesprofi*/ codprod codport reseau dteff dtemi datnai1 datnai2 codfisc typcot codeta DATENCL NUMCONO MTCAPRE OPTMINA mtinv codsoc mtccotf very_sht_name durctv datech);mois=&mm.;dteff2=dteff*1;dtemi2=dtemi*1;format codsociete $3.;if codsoc in ('1' '3') then codsociete='MU';else codsociete='SA';cumul_prime_verse=mtccotf;drop dteff dtemi codsoc mtccotf;rename dteff2=dteff dtemi2=dtemi;run;proc sort data=temp_pm;by codprod profil_gest ;run;proc sort data=gestion;by codprod profil_gest ;run;data temp_pm;merge temp_pm(in=a) gestion(in=b drop=mandat_de_gestion:);by codprod profil_gest ;if a;run;data temp_pms;set &lib..pms(keep=numctv codsup resf);mois=&mm.;if codsup ne "";if substr(codsup,1,1)='P' then codsup=cats('8',substr(codsup,2,4));if substr(codsup,1,1)='Q' then codsup=cats('9',substr(codsup,2,4));PM_UC=0;rename resf=PM;run;proc sort data=temp_pms;by codsup;run;data temp_pms;merge temp_pms(in=a) support(in=b);by codsup;if a;run;data temp_pms;set temp_pms;if TYPE='E' then support='EURO';else support='UC';if support='UC' then PM_UC=PM;drop type;run;proc sort data=temp_pms;by numctv;run;proc sort data=temp_pm;by numctv;run;data &out.;merge temp_pm(in=a) temp_pms(in=b);by numctv;if a or b;if codsup="" then pm=mtinv;run;%mend;%macro recup_pm_nova(an=,mois=,no_lancement=,pole=,table=);%do i=1 %to &mois.; %if &i<10 %then %do;  %let j=0&i.; %end; %else %do;  %let j=&i.; %end; %if &pole.=RS and (&an.<11 or (&an.=11 and &i.<9)) %then %do;   data pm;  set _null_;  run;  %end; %else %do;  libname lib "/mutu/FR/batch/data/prod/IF12/VIE/I&pole.300/&table./M&an.&j." access=readonly;  %pm_nova(out=pm,lib=lib,aa=&an.,mm=&j.); %end; %if &i.=1 %then %do;  data pm&no_lancement.;  set pm;  run; %end; %else %do;  data pm&no_lancement.;  set pm pm&no_lancement.;  run; %end;%end;%if &pole.=RS and &an1.<11 %then %do; data pm; set _null_; run;%end;%else %do; libname lib "/mutu/FR/batch/data/prod/IF12/VIE/I&pole.300/&table./M&an1.12" access=readonly; %pm_nova(out=pm,lib=lib,aa=&an1.,mm=12); data pm; set pm; mois=0; run;%end;data pm&no_lancement.;set pm pm&no_lancement.;run;%mend;/********************************************************************************//*   2A : Recuperation des Flux sur NOVA (même macro que sur RCV)   *//********************************************************************************/%macro flux_nova(out=,lib=,aa=,mm=);data temp_flux_mv; set &lib..mv (keep=numctv NUMSEQ Reseau DTEMIG DTEFFG codact TYPAIE SENACT codprod codport datnai1 datnai2 dteff dtemi); mois=&mm.; format mvt $2.; format d d2 $8.; d=DTEMIG; d2=DTEFFG; informat date_saisie ddmmyy.; format date_saisie ddmmyy.; informat date_mvt ddmmyy.; format date_mvt ddmmyy.; mois=&mm.; date_saisie=mdy(substr(d,5,2),substr(d,7,2),substr(d,1,4)); date_mvt=mdy(substr(d2,5,2),substr(d2,7,2),substr(d2,1,4)); sens=1; if senact='A' then sens=-1; /*senact désigne la variable d'annulation, la variable uniforme sur les réseaux sera sens*/ mvt=codact; if mvt in ("RN" "SE" "RE") then do; /*Renoncé, sans effet et ?*/  mvt="AN";  sens=-1; end; if mvt="VE" then mvt="AN"; if mvt="RR" then mvt="RP"; if mvt="RS" then mvt="RT"; if mvt in ("QH" "QT" "QR" "PA") then mvt="PP"; if mvt in ("EC" "EH") then mvt="E"; if mvt in ("AN" "AS" "AE" "VL" "PP" "RT" "RP" "RG" "SI" "E" ); keep numctv NUMSEQ mvt mois sens codprod codport datnai1 datnai2 dteff reseau dtemi mois date_saisie date_mvt codact;run;data temp_flux_mvs; set &lib..mvs (keep=numctv NUMSEQ codact SENACT codprod codsup MTPMDGF MTMVFR FRAISVAR FRAISFIX); if codsup ne ""; mois=&mm.; sens=1; if senact='A' then sens=-1; mvt=codact; if mvt in ("RN" "SE" "RE") then do;  sens=-1;  mvt="AN"; end; if mvt="VE" then mvt="AN"; if mvt="RR" then mvt="RP"; if mvt="RS" then mvt="RT"; if mvt in ("QH" "QT" "QR" "PA") then mvt="PP"; if mvt in ("EC" "EH") then mvt="E"; if mvt in ("AN" "AS" "AE" "VL" "PP" "RT" "RP" "RG" "SI" "E"); if mvt in ("AN" "VL" "PP") then  do;  montant_brut=abs(MTPMDGF)*sens;  fraisvar=abs(FRAISVAR)*sens;  FRAISfix=abs(fraisfix)*sens; end; else  do;  montant_brut=abs(MTMVFR)*sens;  fraisvar=abs(FRAISVAR)*sens;  FRAISfix=abs(fraisfix)*sens; end; if mvt in ("RT" "RP" "RG" "SI" "E" "AS") then montant_brut=-montant_brut; if montant_brut^=0; if substr(codsup,1,1)='P' then codsup=cats('8',substr(codsup,2,4)); if substr(codsup,1,1)='Q' then codsup=cats('9',substr(codsup,2,4)); keep numctv NUMSEQ mvt mois codsup montant_brut fraisvar sens fraisfix;run;proc sort data=temp_flux_mv;by numctv mvt mois NUMSEQ sens;run;proc sort data=temp_flux_mvs;by numctv mvt mois NUMSEQ sens;run;data &out.(keep=numctv mvt mois reseau codsup montant_brut fraisvar FRAISfix sens codprod codport datnai1 datnai2 dteff dtemi date_saisie date_mvt codact); merge temp_flux_mv(in=a) temp_flux_mvs(in=b); by numctv mvt mois NUMSEQ sens; if a and b;run;%mend;%macro recup_flux_nova(an=,mois=,no_lancement=,pole=,table=);%do i=1 %to &mois.; %if &i<10 %then %do;  %let j=0&i.; %end; %else %do;  %let j=&i.; %end; %if &pole.=RS and (&an.<11 or (&an.=11 and &i.<9)) %then %do;   data flux;  set _null_;  run;  %end; %else %do;  libname lib "/mutu/FR/batch/data/prod/IF12/VIE/I&pole.300/&table./M&an.&j." access=readonly;  %flux_nova(out=flux,lib=lib,aa=&an.,mm=&j.); %end; %if &i.=1 %then %do;  data flux&no_lancement.;  set flux;  run; %end; %else %do;  data flux&no_lancement.;  set flux flux&no_lancement.;  run; %end;%end;%mend;/********************************************************************************//*   3A : Recuperation des PM sur AXV4         *//********************************************************************************/%macro pm_axv4(out=,aa=,mm=);libname axv4 "/mutu/FR/batch/data/prod/IF12/VIE/IAF160/SAXO/INVSTOCK/M20&aa.&mm." access=readonly;/*libname axv4 "/mutu/FR/batch/data/prod/IF12/VIE/IAF160/SAXO/INVSTOCK/M20&an.&mois._12012015" access=readonly;*/data &out.(keep=police reseau codprod codport code_isin pm pm_uc nom_produit nom_support mandat_de_gestion_collectif codeta support mandat_de_gestion_personnalise datnai1 mois dteff dtemi codsociete cumul_prime_verse);set axv4.saxostock(rename=(reseau=res));mois=&mm.;if code_isin ne "";format police $30.;codprod=code_produit;libprod=nom_produit;format reseau $30.;if res = "AV" then reseau = "AGVS";else if res = "AG" then reseau = "AGENTS GENERAUX";else if res = "SA" then reseau = "SALARIES";else if res = "CO" then reseau = "COURTIERS";else if res = "GP" then reseau = "GESTION PRIVEE DIRECTE";else if res = "PB" then reseau = "PARTENARIATS BANCAIRES";else if res = "PA" then reseau = "PARTENARIATS DISTRIBUTION";codport=CODE_APPORTEUR*1;police=numero_contrat;PM=VAL_ACQUISE_CLOT_MONTANT;PM_UC=0;if place_cotation ne "" then PM_UC=PM;datnai1=year(DATE_NAISSANCE_PREMIER_ASSURE)*10000+month(DATE_NAISSANCE_PREMIER_ASSURE)*100+day(DATE_NAISSANCE_PREMIER_ASSURE);dteff=year(DATE_effet_contrat)*10000+month(DATE_effet_contrat)*100+day(DATE_effet_contrat);dtemi=dteff;format codeta $2.;if situation_cloture='en cours' then codeta='EV';else if situation_cloture='rachete' then codeta='RT';else if situation_cloture='renonce' then codeta='RN';else if situation_cloture='resilie' then codeta='SI';else if situation_cloture='sans effet' then codeta='SE';else if situation_cloture='suspendu' then codeta='SU';else codeta='??';format support $4.;support='EURO';if place_cotation ne "" then support='UC';format codsociete $3.;codsociete=societe_juridique;cumul_prime_verse=cumul_primes_versees;run;proc sort data=&out.;by police;run;data &out.;retain temp_prime 0;set &out.;by police;if first.police then temp_prime=cumul_prime_verse;else temp_prime=temp_prime+cumul_prime_verse;run;proc sort data=&out.;by police descending cumul_prime_verse;run;data &out.(drop=temp_prime temp_prime2);retain temp_prime2 0;set &out.;by police;if first.police then temp_prime2=temp_prime;cumul_prime_verse=temp_prime2;run;%mend;%macro recup_pm_axv4(an=,mois=);%do i=1 %to &mois.; %if &i<10 %then %do;  %let j=0&i.; %end; %else %do;  %let j=&i.; %end; %pm_axv4(out=pm&an.&j.,aa=&an.,mm=&j.); %if &i.=1 %then %do;  data pm_axv4;  set pm&an.&j.;  run; %end; %else %do;  data pm_axv4;  set pm&an.&j. pm_axv4;  run; %end;%end;%pm_axv4(out=pm&an1.&j.,aa=&an1.,mm=12);data pm&an1.&j.;set pm&an1.&j.;mois=0;run;data pm_axv4;set pm&an1.&j. pm_axv4;run;%mend;/********************************************************************************//*   3B : Recuperation des Flux sur AXV4         *//********************************************************************************/%macro recup_flux_axiomev4(an=,mois=,out=);libname flux "/mutu/FR/batch/data/prod/IF12/VIE/IAF160/SAXO/INVFLUX/M20&an.&mois." ;data &out.(keep=police mvt code_isin montant_brut montant_brut_uc fraisvar sens date_mvt date_saisie codprod mois fraisfix /*mandat_de_gestion_collectif mandat_de_gestion_personnalise */nom_support reseau support); set flux.saxoflux; if code_isin ne ""; format police $30.; format codprod $5.; format date_mvt ddmmyy.; format mvt $2.; police=numero_contrat; if type_flux in ("AE-AUTO " , "AE-EC   " , "AE-FUS  " , "AE-IP   " , "AE-LIBRE" , "AE-PROG " , "AE-SL   " , "AE-SLM  " , "AN      " , "AS-AUTO " , "AS-EC   " , "AS-FUS  " , "AS-IP   " , "AS-LIBRE" , "AS-PROG " , "AS-SL   " , "AS-SLM  " , "CR      " , "DC      " , "FG      " , "FG-MDT  " , "FG-SOURC" , "FOURGOUS" , "FRAIS-A " , "FRAIS-RP" , "FRAIS-RT" , "IC      " , "MULT    " , "PB      " , "PREL-EP " , "PS      " , "REF     " , "RN      " , "RP      " , "RPROG   " , "RT      " , "SE      " , "SI      " , "VL      " , "VLP     "); if type_flux="VP" then type_flux="PP"; if type_flux in ("FOURGOUS" "AN      ") then mvt="AN"; if type_flux in ("SE      ") then mvt="SE"; if type_flux in ("VL      ") then mvt="VL"; if type_flux in ("VLP     ") then mvt="PP"; if type_flux in ("RP      ") then mvt="RP"; if type_flux in ("RT      ") then mvt="RT"; if type_flux in ("RPROG   ") then mvt="RG"; /* !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! attention : le mouvement DC correspond au détachement de coupons */ if type_flux in ("SI      ") then mvt="SI"; if type_flux in ("AE-AUTO " , "AE-EC   " , "AE-FUS  " , "AE-IP   " , "AE-LIBRE" , "AE-PROG " , "AE-SL   " , "AE-SLM  ") then mvt="AE"; if type_flux in ("AS-AUTO " , "AS-EC   " , "AS-FUS  " , "AS-IP   " , "AS-LIBRE" , "AS-PROG " , "AS-SL   " , "AS-SLM  ") then mvt="AS"; if type_flux in ("RN      ","SE      ") then do;  mvt="AN";  signe_flux="A"; end; if mvt in ("AN" "VL" "RT" "RP" "RG" "SI" "PP" "AE" "AS"); codprod=code_produit; if code_isin=" " then delete; format support $4.; if place_cotation="" then support='EURO';else support='UC'; sens=1; if signe_flux="A" then sens=-1; res=reseau; reseau="NCA";if res = "AV" then reseau = "AGVS";else if res = "AG" then reseau = "AGENTS GENERAUX";else if res = "SA" then reseau = "SALARIES";else if res = "CO" then reseau = "COURTIERS";else if res = "GP" then reseau = "GESTION PRIVEE DIRECTE";else if res = "PB" then reseau = "PARTENARIATS BANCAIRES";else if res = "PA" then reseau = "PARTENARIATS DISTRIBUTION"; montant_brut=abs(montant_brut)*sens; montant_investi=abs(montant_investi)*sens; if mvt in ("RT" "RP" "RG" "SI" "E" "AS") then do;  montant_brut=-montant_brut;  montant_investi=-montant_investi; end; if montant_brut ne 0;montant_brut_uc=0;if support='UC' then montant_brut_uc=montant_brut;date_mvt=date_effet_technique; date_saisie=DATE_comptable; mois=month(date_saisie); fraisvar= montant_brut-montant_investi;/*uniquement les frais variables - les frais fixes sont dans une autre variable*/ fraisfix=0;run;%mend;/********************************************************************************//*   4A : Recuperation des PM sur AXV1         *//********************************************************************************/%macro pm_axv1(out=,aa=,mm=);%if &aa.<11 or (&aa.=11 and &mm.<9) %then %do;libname axv1 "/mutu/FR/batch/data/prod/IF12/VIE/IAF300/AXIOMINV/M&aa.&mm." access=readonly;data &out.(keep=police reseau codprod codport code_isin pm: mandat_de_gestion nom_support datnai1 mois dteff dtemi codeta support situation_cloture codsociete cumul_prime_verse);set axv1.go_sa (in=a keep = canal_aramis numero_contrat date_effet_contrat VAL_ACQUISE_CLOT_MONTANT code_isin vl_clot mandat_de_gestion nom_support place_cotation DATE_NAISSANCE_PREMIER_ASSURE situation_cloture cumul_primes_versees) axv1.go_mu (in=b keep = canal_aramis numero_contrat date_effet_contrat VAL_ACQUISE_CLOT_MONTANT code_isin vl_clot mandat_de_gestion nom_support place_cotation DATE_NAISSANCE_PREMIER_ASSURE situation_cloture cumul_primes_versees) axv1.thema (in=c keep = canal_aramis numero_contrat date_effet_contrat VAL_ACQUISE_CLOT_MONTANT code_isin vl_clot mandat_de_gestion nom_support place_cotation DATE_NAISSANCE_PREMIER_ASSURE situation_cloture cumul_primes_versees) axv1.axiva (in=d keep = canal_aramis numero_contrat date_effet_contrat VAL_ACQUISE_CLOT_MONTANT code_isin vl_clot mandat_de_gestion nom_support place_cotation DATE_NAISSANCE_PREMIER_ASSURE situation_cloture cumul_primes_versees) axv1.argovie (in=e keep = canal_aramis numero_contrat date_effet_contrat VAL_ACQUISE_CLOT_MONTANT code_isin vl_clot mandat_de_gestion nom_support place_cotation DATE_NAISSANCE_PREMIER_ASSURE situation_cloture cumul_primes_versees); mois=&mm.; format reseau $30.; if canal_aramis in ("100","101","102","103","104") then RESEAU = "AGENTS GENERAUX"; else if canal_aramis = "110" then RESEAU = "AGVS"; else if canal_aramis in ("130","131","132","133","134") then RESEAU = "SALARIES"; else if canal_aramis in ("230","231","232","233","234","235") then RESEAU = "COURTIERS"; else if canal_aramis = "236" then RESEAU = "GESTION PRIVEE DIRECTE"; else if canal_aramis = "237" then RESEAU = "PARTENARIATS BANCAIRES"; else if canal_aramis = "238" then RESEAU = "PARTENARIATS DISTRIBUTION"; else if canal_aramis = "210" then RESEAU = "ASTRAL"; else if canal_aramis = "239" then RESEAU = "N/A"; format police $30.; if code_isin="" then delete; police=numero_contrat;  format codprod $5.;  codprod=scan(numero_contrat,1,"/"); PM=VAL_ACQUISE_CLOT_MONTANT; PM_UC=0; if place_cotation ne . then PM_UC=PM; codport=0; format gestion $30.; datnai1=substr(DATE_NAISSANCE_PREMIER_ASSURE,7,4)*10000+substr(DATE_NAISSANCE_PREMIER_ASSURE,4,2)*100+substr(DATE_NAISSANCE_PREMIER_ASSURE,1,2)*1; dteff=substr(DATE_effet_contrat,7,4)*10000+substr(DATE_effet_contrat,4,2)*100+substr(DATE_effet_contrat,1,2)*1; dtemi=dteff; format codeta $2.; if situation_cloture='contrat' then codeta='EV'; else if situation_cloture='rachete' then codeta='RT'; else if situation_cloture='reduit' then codeta='RD'; else if situation_cloture='deces' then codeta='SI'; else if situation_cloture='sanseffet' then codeta='SE'; else if situation_cloture='suspendu' then codeta='SU'; else if situation_cloture='renonce' then codeta='RN'; else if situation_cloture='echu' then codeta='EC'; else codeta='??'; format support $4.; support='EURO'; if place_cotation ne . then support='UC';  format codsociete $3.; if a or c or d then codsociete='SA'; else if b then codsociete='MU'; else if e then codsociete='ARG';  cumul_prime_verse= cumul_primes_versees;run;%end;%else %do;libname axv1 "/mutu/FR/batch/data/prod/IF12/VIE/IAF300/AXIOMINV/M&aa.&mm." access=readonly;data &out.(keep=police reseau codprod codport code_isin pm: mandat_de_gestion nom_support datnai1 mois dteff dtemi codeta support situation_cloture codsociete cumul_prime_verse);set axv1.go_sa (in=a keep = canal_aramis numero_contrat CODE_PORTEFEUILLE date_effet_contrat VAL_ACQUISE_CLOT_MONTANT code_isin vl_clot mandat_de_gestion nom_support place_cotation DATE_NAISSANCE_PREMIER_ASSURE situation_cloture cumul_primes_versees) axv1.go_mu (in=b keep = canal_aramis numero_contrat CODE_PORTEFEUILLE date_effet_contrat VAL_ACQUISE_CLOT_MONTANT code_isin vl_clot mandat_de_gestion nom_support place_cotation DATE_NAISSANCE_PREMIER_ASSURE situation_cloture cumul_primes_versees) axv1.thema (in=c keep = canal_aramis numero_contrat CODE_PORTEFEUILLE date_effet_contrat VAL_ACQUISE_CLOT_MONTANT code_isin vl_clot mandat_de_gestion nom_support place_cotation DATE_NAISSANCE_PREMIER_ASSURE situation_cloture cumul_primes_versees) axv1.axiva (in=d keep = canal_aramis numero_contrat CODE_PORTEFEUILLE date_effet_contrat VAL_ACQUISE_CLOT_MONTANT code_isin vl_clot mandat_de_gestion nom_support place_cotation DATE_NAISSANCE_PREMIER_ASSURE situation_cloture cumul_primes_versees) axv1.argovie (in=e keep = canal_aramis numero_contrat CODE_PORTEFEUILLE date_effet_contrat VAL_ACQUISE_CLOT_MONTANT code_isin vl_clot mandat_de_gestion nom_support place_cotation DATE_NAISSANCE_PREMIER_ASSURE situation_cloture cumul_primes_versees); mois=&mm.; format reseau $30.; if canal_aramis in ("100","101","102","103","104") then RESEAU = "AGENTS GENERAUX"; else if canal_aramis = "110" then RESEAU = "AGVS"; else if canal_aramis in ("130","131","132","133","134") then RESEAU = "SALARIES"; else if canal_aramis in ("230","231","232","233","234","235") then RESEAU = "COURTIERS"; else if canal_aramis = "236" then RESEAU = "GESTION PRIVEE DIRECTE"; else if canal_aramis = "237" then RESEAU = "PARTENARIATS BANCAIRES"; else if canal_aramis = "238" then RESEAU = "PARTENARIATS DISTRIBUTION"; else if canal_aramis = "210" then RESEAU = "ASTRAL"; else if canal_aramis = "239" then RESEAU = "N/A"; format police $30.; if code_isin="" then delete; police=numero_contrat;  format codprod $5.;  codprod=scan(numero_contrat,1,"/"); PM=VAL_ACQUISE_CLOT_MONTANT; PM_UC=0; if place_cotation ne . then PM_UC=PM; codport=CODE_PORTEFEUILLE*1; format gestion $30.; datnai1=substr(DATE_NAISSANCE_PREMIER_ASSURE,7,4)*10000+substr(DATE_NAISSANCE_PREMIER_ASSURE,4,2)*100+substr(DATE_NAISSANCE_PREMIER_ASSURE,1,2)*1; dteff=substr(DATE_effet_contrat,7,4)*10000+substr(DATE_effet_contrat,4,2)*100+substr(DATE_effet_contrat,1,2)*1; dtemi=dteff; format codeta $2.; if situation_cloture='contrat' then codeta='EV'; else if situation_cloture='rachete' then codeta='RT'; else if situation_cloture='reduit' then codeta='RD'; else if situation_cloture='deces' then codeta='SI'; else if situation_cloture='sanseffet' then codeta='SE'; else if situation_cloture='suspendu' then codeta='SU'; else if situation_cloture='renonce' then codeta='RN'; else if situation_cloture='echu' then codeta='EC'; else codeta='??'; format support $4.; support='EURO'; if place_cotation ne . then support='UC'; format codsociete $3.; if a or c or d then codsociete='SA'; else if b then codsociete='MU'; else if e then codsociete='ARG'; cumul_prime_verse= cumul_primes_versees;run;%end;proc sort data=&out.;by police;run;data &out.;retain temp_prime 0;set &out.;by police;if first.police then temp_prime=cumul_prime_verse;else temp_prime=temp_prime+cumul_prime_verse;run;proc sort data=&out.;by police descending cumul_prime_verse;run;data &out.(drop=temp_prime temp_prime2);retain temp_prime2 0;set &out.;by police;if first.police then temp_prime2=temp_prime;cumul_prime_verse=temp_prime2;run;%mend;%macro recup_pm_axv1(an=,mois=);%do i=1 %to &mois.; %if &i<10 %then %do;  %let j=0&i.; %end; %else %do;  %let j=&i.; %end; %pm_axv1(out=pm&an.&j.,aa=&an.,mm=&j.); %if &i.=1 %then %do;  data pm_axv1;  set pm&an.&j.;  run; %end; %else %do;  data pm_axv1;  set pm&an.&j. pm_axv1;  run; %end;%end;%pm_axv1(out=pm&an1.&j.,aa=&an1.,mm=12);data pm&an1.&j.;set pm&an1.&j.;mois=0;run;data pm_axv1;set pm&an1.&j. pm_axv1;run;%mend;/********************************************************************************//*   4B : Recuperation des Flux sur AXV1         *//********************************************************************************/%macro recup_flux_axiomev1(an=,mois=,out=);libname flux "/mutu/FR/batch/data/prod/IF12/VIE/IAF300/AXIOFLUX/M&AN.&Mois." ;data &out.(keep=police mvt code_isin montant_brut montant_brut_uc fraisvar sens date_mvt codprod nom_support support date_saisie mois fraisfix); set flux.flux_axiva flux.flux_gomu flux.flux_argovie flux.flux_fresnel flux.flux_gosa flux.flux_thema;montant_brut_uc=0;format police $30.; format codprod $5.; informat date_mvt ddmmyy.; format date_mvt ddmmyy.;  informat date_saisie2 ddmmyy.; format date_saisie2 ddmmyy.; format mvt $2.; police=numero_contrat; if type_flux="VP" then type_flux="PP"; if type_flux="RR" then type_flux="RP"; if type_flux="RS" then type_flux="RT"; codprod=scan(numero_contrat,1,"/"); /*if codprod in &code_produit.;*/ if code_isin=" " then delete; if type_flux="RN" then do;  type_flux="AN";  signe_flux="A"; end; sens=1; if signe_flux="A" then do;  sens=-1; end; mvt=type_flux; montant_brut=abs(montant_brut)*sens; montant_investi=abs(montant_investi)*sens; if mvt in ("RT" "RP" "RG" "SI" "E" "AS") then do;  montant_brut=-montant_brut;  montant_investi=-montant_investi; end;  if DATE_COMPTABLE not in ("." "" "00/00/0000");format support $4.;if valeur_liquidative=1 then support='EURO';else support='UC'; if support='UC' then montant_brut_uc=montant_brut; date_mvt=mdy(substr(DATE_EFFET_TECHNIQUE,4,2),substr(DATE_EFFET_TECHNIQUE,1,2),substr(DATE_EFFET_TECHNIQUE,7,4)); date_saisie2=mdy(substr(DATE_COMPTABLE,4,2),substr(DATE_COMPTABLE,1,2),substr(DATE_COMPTABLE,7,4)); fraisvar=montant_brut-montant_investi; fraisfix=0; mois=month(date_saisie2); drop type_flux DATE_EFFET_TECHNIQUE DATE_COMPTABLE date_saisie; rename date_saisie2=date_saisie;run;%mend;
